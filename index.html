<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem E-Umar</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E40AF',
                        secondary: '#64748B',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E40AF">
    <link rel="apple-touch-icon" href="image/logo_new.png">
</head>

<body class="bg-slate-50 text-slate-800 h-screen w-full overflow-hidden">
    <div id="app" v-cloak class="w-full h-full flex flex-col relative text-sm">

        <!-- LOGIN VIEW (Redesigned) -->
        <!-- LOGIN VIEW (Component) -->
        <login-view v-if="currentView === 'login'" :app-name="appName" :app-version="appVersion" :login-form="loginForm"
            @login="handleLogin"></login-view>

        <!-- MAIN APP VIEW -->
        <div v-else class="flex h-full w-full">

            <!-- SIDEBAR (Desktop) -->
            <aside v-if="isSidebarVisible"
                class="hidden md:flex flex-col w-64 bg-white border-r border-slate-200 h-full fixed left-0 top-0 z-30 shadow-sm">
                <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                    <div
                        class="w-12 h-12 bg-white rounded-xl flex items-center justify-center border border-slate-100 shadow-sm overflow-hidden p-1">
                        <img src="image/logo_new.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <h1 class="text-slate-900 font-bold text-lg leading-none">E-Umar</h1>
                        <p class="text-slate-500 text-[10px] mt-1 pr-2 leading-tight">Aplikasi Akademik<br>Umar Bin
                            Khattab</p>
                    </div>
                </div>
                <div class="flex-1 p-4 space-y-1 overflow-y-auto">
                    <button v-for="menu in myMenus" :key="menu.id" @click="navigateTo(menu.id)"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium text-sm"
                        :class="currentView === menu.id ? 'bg-primary text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'">
                        <span class="material-symbols-outlined">{{ menu.icon }}</span>
                        {{ menu.label }}
                    </button>
                    <!-- LOGOUT (Sidebar) -->
                    <button @click="logout"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-500 hover:bg-red-50 font-medium text-sm mt-4">
                        <span class="material-symbols-outlined">logout</span> Keluar
                    </button>
                </div>

                <!-- MONITORING BELL (Desktop Sidebar) -->
                <div v-if="userSession && userSession.role !== 'santri'" class="p-4 border-t border-slate-100 pb-0">
                    <button @click="openMonitoringModal()"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-50 font-medium text-sm text-slate-500 relative">
                        <div class="relative">
                            <span class="material-symbols-outlined">notifications</span>
                            <span v-if="notificationCount > 0"
                                class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[9px] font-bold text-white ring-2 ring-white">
                                {{ notificationCount }}
                            </span>
                        </div>
                        Monitoring
                    </button>
                </div>
                <!-- User Profile -->
                <div class="p-4 border-t border-slate-100">
                    <div @click="navigateTo('profile')"
                        class="flex items-center gap-3 p-2 rounded-xl hover:bg-slate-50 cursor-pointer transition group">
                        <div
                            class="size-8 bg-blue-100 text-primary rounded-full flex items-center justify-center font-bold text-xs group-hover:bg-primary group-hover:text-white transition">
                            {{ getInitials(userSession.full_name) }}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <p class="text-xs font-bold text-slate-900 truncate group-hover:text-primary">{{
                                userSession.full_name }}</p>
                            <p class="text-[10px] text-slate-500 truncate">{{ userSession.role }}</p>
                        </div>
                        <span class="material-symbols-outlined text-slate-300 text-sm">settings</span>
                    </div>
                </div>
            </aside>

            <!-- MAIN CONTENT AREA -->
            <div class="flex-1 flex flex-col h-full md:pl-64 bg-slate-50 relative w-full">

                <!-- MOBILE HEADER -->
                <header v-if="isHeaderVisible"
                    class="md:hidden fixed top-0 left-0 right-0 z-40 bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 h-16 flex items-center justify-between shadow-sm">
                    <div class="flex items-center gap-3">
                        <img src="image/logo_new.png" alt="Logo" class="w-8 h-8 object-contain">
                        <div class="flex flex-col">
                            <h2 class="font-bold text-slate-800 text-sm leading-none tracking-tight">E-Umar</h2>
                            <p class="text-[9px] text-slate-500 font-medium leading-none mt-0.5">Aplikasi
                                Akademik<br>Umar Bin Khattab</p>
                        </div>
                    </div>
                    <!-- Optional: Right Header Items (e.g. Profile) -->
                    <!-- Sync Indicator & Profile -->
                    <div class="flex items-center gap-2">
                        <!-- MONITORING BELL (Mobile Header) -->
                        <button v-if="userSession && userSession.role !== 'santri'" @click="openMonitoringModal()"
                            class="mr-1 relative p-1.5 text-slate-500 hover:bg-slate-50 rounded-full transition">
                            <span class="material-symbols-outlined">notifications</span>
                            <span v-if="notificationCount > 0"
                                class="absolute top-1 right-1 flex h-3 w-3 items-center justify-center rounded-full bg-red-500 text-[8px] font-bold text-white ring-1 ring-white">
                                {{ notificationCount }}
                            </span>
                        </button>
                        <!-- QURAN MENU BUTTON (Only in Quran View) -->
                        <button v-if="currentView === 'quran'" @click="quranState.showDrawer = true"
                            class="mr-2 text-slate-600 hover:text-primary transition flex items-center">
                            <span class="material-symbols-outlined text-2xl">menu</span>
                        </button>

                        <!-- Sync Status -->
                        <div v-if="syncState.status === 'uploading'"
                            class="flex items-center justify-center size-8 bg-blue-50 rounded-full border border-blue-100">
                            <span
                                class="material-symbols-outlined text-[20px] text-primary animate-pulse">cloud_upload</span>
                        </div>
                        <div v-else-if="syncState.status === 'saved'"
                            class="flex items-center justify-center size-8 bg-green-50 rounded-full border border-green-100 fade-in">
                            <span class="material-symbols-outlined text-[20px] text-green-600">cloud_done</span>
                        </div>
                    </div>
                </header>

                <!-- SCROLLABLE CONTENT -->
                <main class="flex-1 w-full md:transition-all" :class="[
                        currentView === 'quran' ? 'p-0 h-full overflow-hidden' : 'overflow-y-auto px-4 pb-24 md:px-6 md:py-6 md:pb-8',
                        isHeaderVisible ? (currentView === 'quran' ? 'pt-20 md:pt-0' : 'pt-20') : ''
                    ]">

                    <!-- DASHBOARD SKELETON -->
                    <div v-if="loading && currentView === 'dashboard'" class="fade-in space-y-6 animate-pulse">
                        <!-- Greeting Card Skeleton -->
                        <div
                            class="bg-white p-5 rounded-3xl border border-slate-100 card-shadow flex items-center gap-4">
                            <div class="size-12 rounded-full bg-slate-200"></div>
                            <div class="space-y-2 flex-1">
                                <div class="h-4 bg-slate-200 rounded w-1/3"></div>
                                <div class="h-3 bg-slate-200 rounded w-1/4"></div>
                            </div>
                        </div>

                        <!-- Menu Grid Skeleton -->
                        <div class="grid grid-cols-4 gap-3">
                            <div v-for="i in 8" :key="i" class="flex flex-col items-center gap-2">
                                <div class="size-14 rounded-2xl bg-slate-200"></div>
                                <div class="h-2 bg-slate-200 rounded w-10"></div>
                            </div>
                        </div>

                        <!-- Recent Activity Skeleton -->
                        <div class="space-y-3">
                            <div class="h-4 bg-slate-200 rounded w-1/3 mb-2"></div>
                            <div v-for="i in 3" :key="i"
                                class="bg-white p-4 rounded-xl border border-slate-100 flex gap-3">
                                <div class="size-10 rounded-full bg-slate-200"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="h-3 bg-slate-200 rounded w-3/4"></div>
                                    <div class="h-2 bg-slate-200 rounded w-1/2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DASHBOARD VIEW -->
                    <!-- DASHBOARD VIEW (Component) -->
                    <div v-if="!loading && currentView === 'dashboard'" class="h-full w-full">
                        <dashboard-view :user-session="userSession" :dashboard-stats="dashboardStats"
                            :my-menus="myMenus" :activity-filter="activityFilter"
                            :filtered-activities="filteredActivities" :loading="loading"
                            :top-santri-filter="topSantriFilter" :filtered-top-santri="filteredTopSantri"
                            @update:activity-filter="activityFilter = $event"
                            @update:top-santri-filter="topSantriFilter = $event"
                            @navigate="navigateTo"></dashboard-view>
                    </div>
                    <!-- SANTRI VIEW SKELETON -->
                    <div v-if="loading && currentView === 'santri'" class="animate-pulse px-4 space-y-4 pt-4">
                        <div class="h-8 bg-slate-200 rounded-lg w-full mb-4"></div>
                        <div class="flex gap-2 mb-4">
                            <div class="h-8 bg-slate-200 rounded-lg flex-1"></div>
                            <div class="h-8 bg-slate-200 rounded-lg flex-1"></div>
                        </div>
                        <div v-for="i in 6" :key="i"
                            class="bg-white p-4 rounded-xl border border-slate-100 flex items-center gap-4">
                            <div class="size-12 rounded-full bg-slate-200"></div>
                            <div class="flex-1 space-y-2">
                                <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                                <div class="h-3 bg-slate-200 rounded w-1/3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- SANTRI VIEW -->

                    <!-- SANTRI VIEW (Component) -->
                    <div v-if="!loading && currentView === 'santri'" class="h-full w-full">
                        <santri-view :user-session="userSession" :santri-gender-filter="santriGenderFilter"
                            :search-text="searchText" :filtered-santri="filteredSantri"
                            :active-dropdown="activeDropdown" :ui-data="uiData" :loading="loading"
                            :show-trash="showTrash" @update:santri-gender-filter="santriGenderFilter = $event"
                            @update:search-text="searchText = $event" @open-modal="openSantriModal"
                            @delete="deleteSantri" @restore="restoreSantri" @toggle-dropdown="toggleDropdown"
                            @toggle-trash="toggleTrash"></santri-view>
                    </div>


                    <!-- GURU VIEW (Component) -->
                    <div v-if="currentView === 'guru'" class="h-full w-full">
                        <guru-view :filtered-guru="filteredGuru" :active-dropdown="activeDropdown"
                            @open-modal="openGuruModal" @delete="deleteGuru"
                            @toggle-dropdown="toggleDropdown"></guru-view>
                    </div>
                    <!-- UJIAN VIEW -->

                    <!-- UJIAN VIEW (Component) -->
                    <div v-if="currentView === 'ujian'" class="h-full w-full">
                        <ujian-view :user-session="userSession" :ui-data="uiData" :loading="loading"
                            :ujian-form="ujianForm" :mapel-list="mapelList"
                            :selected-santri-bulanan-stats="selectedSantriBulananStats"
                            :selected-santri-progress="selectedSantriProgress" :filtered-ujian="filteredUjian"
                            @start-bulanan-exam="startBulananExam" @calc-bulanan-score="calcBulananScore"
                            @calc-semester-score="calcSemesterScore" @select-ujian-juz="selectUjianJuz"
                            @submit-ujian="submitUjian"></ujian-view>
                    </div>

                    <!-- DUPLICATE PELANGGARAN VIEW REMOVED -->




                    <!-- JADWAL VIEW -->



                    <!-- INPUT/SETORAN VIEW (Component) -->
                    <div v-if="currentView === 'input'" class="h-full w-full">
                        <setoran-view :setoran-form="setoranForm" :setoran-santri-search="setoranSantriSearch"
                            @update:setoran-santri-search="setoranSantriSearch = $event"
                            :is-setoran-santri-dropdown-open="isSetoranSantriDropdownOpen"
                            @update:is-setoran-santri-dropdown-open="isSetoranSantriDropdownOpen = $event"
                            :setoran-filtered-santri-options="setoranFilteredSantriOptions"
                            :setoran-selected-santri-name="setoranSelectedSantriName" :surah-list="surahList"
                            :surah-hints="surahHints" :auto-calc-info="autoCalcInfo" :recent-setoran="recentSetoran"
                            :is-menu-open="isMenuOpen" @select-setoran-santri="selectSetoranSantri"
                            @change-setoran-type="changeSetoranType" @sync-surah="syncSurah"
                            @validate-ayat="validateAyat" @toggle-manzil-mode="toggleManzilMode"
                            @calc-pages-from-range="calcPagesFromRange" @adjust-value="adjustValue"
                            @update-grade="updateGrade" @save-setoran="saveSetoran" @edit-setoran="editSetoran"
                            @delete-setoran="deleteSetoran" @toggle-menu="toggleMenu"></setoran-view>
                    </div>
                    <!-- TARGET VIEW (Component) -->
                    <div v-if="currentView === 'target'" class="fade-in">
                        <target-view :santri-data="santriWithTarget" :user-session="userSession"
                            :active-dropdown="activeDropdown" @open-target-modal="openTargetModal"
                            @reset-target="resetTarget" @toggle-dropdown="toggleDropdown"></target-view>
                    </div>

                    <!-- RIWAYAT & REKAP VIEW -->
                    <!-- RIWAYAT VIEW (Component) -->
                    <div v-if="currentView === 'riwayat'">
                        <riwayat-view :riwayat-state="riwayatState" :paginated-riwayat="paginatedRiwayat"
                            :riwayat-total-pages="riwayatTotalPages"
                            :riwayat-filtered-santri-options="riwayatFilteredSantriOptions"
                            :riwayat-filtered-santri-options="riwayatFilteredSantriOptions"
                            :riwayat-selected-santri-name="riwayatSelectedSantriName" :filter-counts="filterCounts"
                            :active-filter-count="activeFilterCount" :user-session="userSession"
                            :format-date-long="formatDateLong" :format-time="formatTime"
                            :get-santri-name="getSantriName" :get-juz-from-page="getJuzFromPage"
                            :select-riwayat-santri="selectRiwayatSantri" :toggle-select="toggleSelect"
                            :toggle-select-all="toggleSelectAll" :delete-selected="deleteSelected"
                            :toggle-action-menu="toggleActionMenu" :close-action-menu="closeActionMenu"
                            :edit-riwayat="editRiwayat" :delete-riwayat="deleteRiwayat"></riwayat-view>
                    </div>

                    <!-- REKAP VIEW (New v34) -->
                    <!-- REKAP VIEW (Component) -->
                    <div v-if="currentView === 'rekap'">
                        <rekap-view v-model:rekap-month="rekapMonth" v-model:rekap-year="rekapYear"
                            v-model:rekap-kelas="rekapKelas" v-model:rekap-gender="rekapGender"
                            :month-names="monthNames" :kelas-options="uiData.kelas"
                            :rekap-hafalan-data="rekapHafalanData" @export-to-excel="exportToExcel"
                            @export-to-pdf="exportToPDF"></rekap-view>
                    </div>

                    <!-- JADWAL VIEW (Component) -->
                    <div v-if="currentView === 'jadwal'">
                        <jadwal-view :filtered-jadwal-list="filteredJadwalList" :day-filter="dayFilter"
                            :set-day-filter="setDayFilter" :jadwal-gender-filter="jadwalGenderFilter"
                            :active-dropdown="activeDropdown" @update:jadwal-gender-filter="jadwalGenderFilter = $event"
                            :open-jadwal-modal="openJadwalModal" :delete-jadwal="deleteJadwal"
                            :user-session="userSession" @toggle-dropdown="toggleDropdown"></jadwal-view>
                    </div>

                    <!-- ABSENSI VIEW (Component) -->
                    <div v-if="currentView === 'absensi'">
                        <absensi-view :absensi-state="absensiState" :daily-jadwal="dailyJadwal"
                            :gender-filter="genderFilter" :absensi-day-name="absensiDayName"
                            :get-absensi-for-jadwal="getAbsensiForJadwal" :get-absensi-summary="getAbsensiSummary"
                            :change-absensi-date="changeAbsensiDate" :open-absensi-page="openAbsensiPage"
                            @update:gender-filter="genderFilter = $event" :user-session="userSession"></absensi-view>
                    </div>

                    <!-- PROFILE VIEW (Component) -->
                    <div v-if="currentView === 'profile'">
                        <profile-view :user-session="userSession" :profile-form="profileForm"
                            :save-profile="saveProfile" :logout="logout" :handle-file-select="handleFileSelect"
                            :is-uploading="isUploading" :get-initials="getInitials"
                            :app-version="appVersion"></profile-view>
                    </div>



                    <!-- MAPEL VIEW -->
                    <div v-if="currentView === 'mapel'" class="fade-in space-y-4 pb-24">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-slate-900">Mata Pelajaran</h2>
                            <button @click="openMapelModal()"
                                class="bg-primary text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-primary/30 active:scale-95 transition">
                                + Tambah
                            </button>
                        </div>

                        <!-- Mapel List -->
                        <div class="space-y-3">
                            <div v-for="mapel in filteredMapel" :key="mapel._id"
                                class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center hover:shadow-md transition">
                                <h3 class="font-bold text-slate-900">{{ mapel.name }}</h3>
                                <div class="relative">
                                    <button @click.stop="toggleDropdown(mapel._id)"
                                        class="size-8 flex items-center justify-center text-slate-300 hover:text-primary hover:bg-slate-50 rounded-full transition">
                                        <span class="material-symbols-outlined">more_vert</span>
                                    </button>

                                    <!-- Backdrop -->
                                    <div v-if="activeDropdown === mapel._id" class="fixed inset-0 z-10 cursor-default"
                                        @click.stop="toggleDropdown(null)"></div>

                                    <!-- Dropdown Menu -->
                                    <div v-if="activeDropdown === mapel._id"
                                        class="absolute right-9 -top-1 w-32 bg-white border border-slate-100 shadow-xl rounded-xl z-20 flex flex-col py-1 overflow-hidden animate-in fade-in zoom-in-95 duration-100 origin-top-right">
                                        <button @click="openMapelModal(mapel); toggleDropdown(null)"
                                            class="flex items-center gap-2 px-4 py-1.5 text-xs font-bold text-slate-600 hover:bg-blue-50 hover:text-blue-600 transition text-left w-full">
                                            <span class="material-symbols-outlined text-base">edit</span> Edit
                                        </button>
                                        <button @click="deleteMapel(mapel._id); toggleDropdown(null)"
                                            class="flex items-center gap-2 px-4 py-1.5 text-xs font-bold text-slate-600 hover:bg-red-50 hover:text-red-500 transition text-left w-full">
                                            <span class="material-symbols-outlined text-base">delete</span> Hapus
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div v-if="!filteredMapel || filteredMapel.length === 0"
                                class="text-center py-12 text-slate-400">
                                <span class="material-symbols-outlined text-6xl opacity-20">book_2</span>
                                <p class="mt-2 text-sm">Belum ada mata pelajaran</p>
                            </div>
                        </div>
                    </div>

                    <!-- KELAS VIEW -->
                    <div v-if="currentView === 'kelas'" class="fade-in space-y-4 pb-24">
                        <div class="flex justify-between items-center px-2">
                            <h2 class="text-2xl font-bold text-slate-900">Data Kelas</h2>
                            <button @click="openKelasModal()"
                                class="bg-primary text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-primary/30 active:scale-95 transition">
                                + Tambah
                            </button>
                        </div>

                        <!-- Kelas List -->
                        <div class="space-y-3 px-2">
                            <div v-for="kelas in filteredKelas" :key="kelas._id"
                                class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center hover:shadow-md transition">
                                <h3 class="font-bold text-slate-900">{{ kelas.name }}</h3>
                                <div class="relative">
                                    <button @click.stop="toggleDropdown(kelas._id)"
                                        class="size-8 flex items-center justify-center text-slate-300 hover:text-primary hover:bg-slate-50 rounded-full transition">
                                        <span class="material-symbols-outlined">more_vert</span>
                                    </button>

                                    <!-- Backdrop -->
                                    <div v-if="activeDropdown === kelas._id" class="fixed inset-0 z-10 cursor-default"
                                        @click.stop="toggleDropdown(null)"></div>

                                    <!-- Dropdown Menu -->
                                    <div v-if="activeDropdown === kelas._id"
                                        class="absolute right-9 -top-1 w-32 bg-white border border-slate-100 shadow-xl rounded-xl z-20 flex flex-col py-1 overflow-hidden animate-in fade-in zoom-in-95 duration-100 origin-top-right">
                                        <button @click="openKelasModal(kelas); toggleDropdown(null)"
                                            class="flex items-center gap-2 px-4 py-1.5 text-xs font-bold text-slate-600 hover:bg-blue-50 hover:text-blue-600 transition text-left w-full">
                                            <span class="material-symbols-outlined text-base">edit</span> Edit
                                        </button>
                                        <button @click="deleteKelas(kelas._id); toggleDropdown(null)"
                                            class="flex items-center gap-2 px-4 py-1.5 text-xs font-bold text-slate-600 hover:bg-red-50 hover:text-red-500 transition text-left w-full">
                                            <span class="material-symbols-outlined text-base">delete</span> Hapus
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div v-if="!filteredKelas || filteredKelas.length === 0"
                                class="text-center py-12 text-slate-400">
                                <span class="material-symbols-outlined text-6xl opacity-20">meeting_room</span>
                                <p class="mt-2 text-sm">Belum ada data kelas</p>
                            </div>
                        </div>
                    </div>

                    <!-- QURAN VIEW -->
                    <div v-if="currentView === 'quran'"
                        class="fixed top-16 bottom-0 left-0 right-0 flex flex-col bg-slate-50 pb-24 md:static md:pb-0 md:h-[calc(100vh-4rem)] z-0">
                        <!-- Header (Mobile only) Removed as per request, using global header -->

                        <!-- Quran Info Bar (Top) -->
                        <div
                            class="w-full bg-white border-b border-slate-200 px-4 py-2 flex justify-between items-center shadow-sm z-10 sticky top-0">
                            <span class="font-bold text-slate-500 text-xs w-1/3 text-left">Juz {{ currentJuz
                                }}</span>
                            <span
                                class="font-bold text-slate-900 text-sm w-1/3 text-center bg-slate-100 rounded-md py-1">{{
                                quranState.page }}</span>
                            <span class="font-bold text-primary text-xs w-1/3 text-right truncate">{{
                                currentSurahName
                                }}</span>
                        </div>


                        <!-- Main Viewer Area -->
                        <div
                            class="flex-1 relative overflow-y-auto overflow-x-hidden bg-[#fdfaf7] flex flex-col items-center justify-start">
                            <div @touchstart="handleTouchStart" @touchmove="handleTouchMove" @touchend="handleTouchEnd"
                                class="w-full min-h-full flex items-start justify-center relative p-0 md:p-0 md:h-full">
                                <img :src="quranImageSrc"
                                    class="w-full h-auto shadow-lg transition-opacity duration-200 select-none border border-[#f0e6d2] md:max-h-full md:max-w-full md:object-contain md:h-full md:w-auto mt-0"
                                    alt="Halaman Quran">

                                <!-- Click Areas for Nav (Invisible) -->
                                <div class="absolute inset-0 flex">
                                    <div @click="nextQPage"
                                        class="w-1/2 h-full z-10 cursor-pointer active:bg-black/5 transition"
                                        title="Lanjut (Next)"></div>
                                    <div @click="prevQPage"
                                        class="w-1/2 h-full z-10 cursor-pointer active:bg-black/5 transition"
                                        title="Kembali (Prev)"></div>
                                </div>

                                <!-- Desktop Drawer Toggle Only -->
                                <button @click="quranState.showDrawer = true"
                                    class="hidden md:flex absolute top-4 right-4 size-10 bg-white/50 hover:bg-white rounded-full items-center justify-center shadow z-20 text-slate-700 hover:text-primary transition"
                                    title="Menu Quran">
                                    <span class="material-symbols-outlined">menu</span>
                                </button>
                            </div>
                        </div>

                        <!-- Footer Info Removed -->


                        <!-- Draggable Exam Controls -->
                        <div v-if="showExamControls && currentView === 'quran' && ujianForm.santri_id"
                            class="fixed inset-0 z-40 bg-transparent" @click="showExamControls = false"></div>

                        <div v-if="currentView === 'quran' && ujianForm.santri_id && showExamControls"
                            class="fixed z-50 bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden w-40 touch-none transition-shadow hover:shadow-xl active:shadow-2xl"
                            :style="{ left: examControlPos.x + 'px', top: examControlPos.y + 'px' }"
                            @touchstart.passive="startDragExamControl" @touchmove.passive="dragExamControl"
                            @touchend="endDragExamControl" @mousedown="startDragExamControl"
                            @mousemove="dragExamControl" @mouseup="endDragExamControl" @mouseleave="endDragExamControl">

                            <!-- Drag Handle -->
                            <div class="bg-primary px-3 py-2 cursor-move flex items-center justify-between text-white">
                                <span class="text-[10px] font-bold uppercase tracking-wider">Kesalahan</span>
                                <span class="material-symbols-outlined text-sm opacity-50">drag_indicator</span>
                            </div>

                            <!-- Content -->
                            <div class="p-3 bg-white space-y-3">
                                <!-- Counter -->
                                <div class="flex items-center justify-between gap-2">
                                    <button @click="updateSalah(-1)"
                                        class="size-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 active:scale-95 transition">
                                        <span class="material-symbols-outlined text-lg">remove</span>
                                    </button>
                                    <span class="text-2xl font-black text-red-500 min-w-[30px] text-center">{{
                                        ujianForm.tab === 'bulanan' ? ujianForm.b_salah : ujianForm.s_salah
                                        }}</span>
                                    <button @click="updateSalah(1)"
                                        class="size-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 active:scale-95 transition">
                                        <span class="material-symbols-outlined text-lg">add</span>
                                    </button>
                                </div>

                                <!-- Finish Button -->
                                <button @click="finishExam"
                                    class="w-full py-2 bg-emerald-50 text-emerald-600 rounded-xl text-xs font-bold flex items-center justify-center gap-1 hover:bg-emerald-100 transition active:scale-95">
                                    <span class="material-symbols-outlined text-sm">check</span> Selesai
                                </button>
                            </div>
                        </div>

                        <!-- Drawer (Jump) -->
                        <div v-if="quranState.showDrawer" class="absolute inset-0 bg-black/50 z-30"
                            @click.self="quranState.showDrawer=false">
                            <div
                                class="absolute right-0 top-0 bottom-0 w-80 bg-white shadow-2xl flex flex-col animate-slide-in-right">
                                <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                                    <h3 class="font-bold text-slate-800">Navigasi Quran</h3>
                                    <button @click="quranState.showDrawer=false"
                                        class="size-8 flex items-center justify-center hover:bg-slate-200 rounded-full"><span
                                            class="material-symbols-outlined">close</span></button>
                                </div>
                                <div class="p-4 space-y-6 overflow-y-auto flex-1 h-full pb-20">
                                    <!-- 1. Jump Page -->
                                    <div class="space-y-2">
                                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Loncat
                                            ke Halaman</label>
                                        <div class="flex gap-2">
                                            <input v-model="quranState.jumpPage" type="number"
                                                class="w-full border rounded-lg px-3 py-2 text-sm font-bold bg-white focus:outline-none focus:border-primary"
                                                min="1" max="604" placeholder="1 - 604">
                                            <button @click="jumpToPage"
                                                class="bg-primary text-white px-4 py-2 rounded-lg font-bold text-sm">Go</button>
                                        </div>
                                    </div>

                                    <!-- 2. Cari Surat & Ayat -->
                                    <div class="space-y-3 pt-4 border-t border-dashed">
                                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Cari
                                            Surat & Ayat</label>
                                        <select v-model="quranState.jumpSurah"
                                            class="w-full border rounded-lg px-3 py-2 text-sm font-bold bg-white mb-2">
                                            <option value="">Pilih Surat...</option>
                                            <option v-for="s in uiData.surahList" :value="s.no">{{ s.no }}. {{
                                                s.latin
                                                }}</option>
                                        </select>
                                        <div class="flex gap-2">
                                            <input v-model="quranState.jumpAyat" type="number"
                                                class="w-full border rounded-lg px-3 py-2 text-sm font-bold bg-white focus:outline-none focus:border-primary"
                                                placeholder="Ayat No.">
                                            <button @click="jumpToAyat"
                                                class="bg-primary text-white px-4 py-2 rounded-lg font-bold text-sm">Cari</button>
                                        </div>
                                    </div>

                                    <!-- 3. Indeks Juz -->
                                    <div class="space-y-2 pt-4 border-t border-dashed">
                                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Indeks
                                            Juz</label>
                                        <select @change="goToJuz($event.target.value)"
                                            class="w-full border rounded-lg px-3 py-2 text-sm font-bold bg-white mb-2">
                                            <option value="">Pilih Juz...</option>
                                            <option v-for="j in 30" :key="j" :value="j">Juz {{ j }}</option>
                                        </select>
                                    </div>

                                    <!-- 4. Indeks Surat -->
                                    <div class="space-y-2 pt-4 border-t border-dashed">
                                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Indeks
                                            Surat</label>
                                        <div class="space-y-1">
                                            <button v-for="s in uiData.surahList" :key="s.no" @click="goToSurah(s.no)"
                                                class="w-full text-left p-2 rounded hover:bg-slate-50 flex items-center gap-3 border-b border-transparent hover:border-slate-100 transition group">
                                                <span
                                                    class="font-bold text-xs text-slate-400 group-hover:text-primary w-6">{{
                                                    s.no }}</span>
                                                <div class="flex-1">
                                                    <p class="font-bold text-sm text-slate-800">{{ s.latin }}
                                                    </p>
                                                    <p class="text-[10px] text-slate-400 italic">{{ s.arti }} &bull;
                                                        {{
                                                        s.ayat }} Ayat</p>
                                                </div>
                                            </button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="currentView === 'hafalan'" class="fade-in pb-24">

                        <!-- List Santri (Monitoring) -->
                        <div v-if="!ujianForm.santri_id" class="px-4 pt-4 space-y-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">Monitoring Hafalan</h2>
                                <p class="text-xs text-slate-500">Pantau progres 30 Juz santri.</p>
                            </div>

                            <div class="bg-white p-3 rounded-xl border shadow-sm sticky top-0 z-20">
                                <input v-model="searchText" type="text" placeholder="Cari Nama Santri..."
                                    class="w-full p-2 bg-slate-50 border rounded-lg text-sm font-bold focus:outline-none focus:border-primary">
                            </div>

                            <!-- Gender Filter -->
                            <div class="flex p-1 bg-slate-100 rounded-xl mb-4">
                                <button @click="santriGenderFilter = 'L'"
                                    :class="santriGenderFilter === 'L' ? 'bg-white text-blue-600 shadow-sm font-bold' : 'text-slate-500 hover:text-slate-700'"
                                    class="flex-1 py-2 text-xs rounded-lg transition-all">
                                    Putra
                                </button>
                                <button @click="santriGenderFilter = 'P'"
                                    :class="santriGenderFilter === 'P' ? 'bg-white text-pink-500 shadow-sm font-bold' : 'text-slate-500 hover:text-slate-700'"
                                    class="flex-1 py-2 text-xs rounded-lg transition-all">
                                    Putri
                                </button>
                            </div>

                            <div class="space-y-3">
                                <div v-for="s in filteredSantri" :key="s._id"
                                    @click="ujianForm.santri_id = s.santri_id; ujianForm.tab='semester'; selectUjianJuz(null)"
                                    class="bg-white p-4 rounded-2xl border shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50 transition group">
                                    <div class="flex items-center gap-4 flex-1 min-w-0">
                                        <div
                                            class="size-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center font-bold text-lg shadow-lg shadow-indigo-200 flex-shrink-0">
                                            {{ (s.hafalan_manual || '0 Juz').split(' ')[0] }}
                                        </div>
                                        <div class="min-w-0">
                                            <h4
                                                class="font-bold text-slate-900 group-hover:text-primary transition truncate">
                                                {{
                                                s.full_name }}</h4>
                                            <p class="text-xs text-slate-500 font-mono truncate">
                                                {{ s.kelas || 'No Kelas' }} &bull; {{ s.hafalan_manual || '0 Juz' }}
                                            </p>
                                        </div>
                                    </div>
                                    <span
                                        class="material-symbols-outlined text-slate-300 flex-shrink-0">chevron_right</span>
                                </div>
                            </div>
                        </div>

                        <!-- Detail Grid (30 Juz) -->
                        <div v-else class="px-4 pt-4 space-y-4">
                            <div class="flex items-center gap-3">
                                <button @click="ujianForm.santri_id = ''"
                                    class="size-10 rounded-full bg-white border shadow-sm flex items-center justify-center hover:bg-slate-50">
                                    <span class="material-symbols-outlined">arrow_back</span>
                                </button>
                                <div>
                                    <h2 class="text-xl font-bold text-slate-900">{{
                                        getSantriName(ujianForm.santri_id)
                                        }}</h2>
                                    <p class="text-xs text-slate-500">Progres 30 Juz</p>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-3xl border shadow-sm mx-2">
                                <div class="grid grid-cols-5 gap-3 sm:gap-4 justify-items-center">
                                    <button v-for="j in 30" :key="j"
                                        @click="selectUjianJuz(j); modalState.view='grading'; modalState.isOpen=true;"
                                        class="size-12 sm:size-14 rounded-full border-2 flex flex-col items-center justify-center transition-all transform hover:scale-110 active:scale-95 bg-slate-50 text-slate-400 border-slate-200 hover:border-emerald-300"
                                        :class="{
                                            'bg-blue-500 text-white shadow-lg shadow-blue-200 border-transparent': selectedSantriProgress[j] && ['A+', 'A'].includes(selectedSantriProgress[j]),
                                            'bg-emerald-500 text-white shadow-lg shadow-emerald-200 border-transparent': selectedSantriProgress[j] && ['B+', 'B', 'B-', 'B'].includes(selectedSantriProgress[j]),
                                            'bg-red-500 text-white shadow-lg shadow-red-200 border-transparent': selectedSantriProgress[j] === 'C',
                                            'bg-orange-400 text-white shadow-lg shadow-orange-200 border-transparent': selectedSantriProgress[j] === 'Centang'
                                        }">
                                        <!-- Icon for Centang -->
                                        <span v-if="selectedSantriProgress[j] === 'Centang'"
                                            class="material-symbols-outlined text-2xl font-bold">check</span>

                                        <!-- Number for Others -->
                                        <span v-else class="text-sm sm:text-lg font-bold">{{ j }}</span>

                                        <!-- Grade Label (if not Centang) -->
                                        <span
                                            v-if="selectedSantriProgress[j] && selectedSantriProgress[j] !== 'Centang'"
                                            class="text-[9px] font-black uppercase tracking-tighter opacity-90">
                                            {{ selectedSantriProgress[j] }}
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PELANGGARAN VIEW -->
                    <!-- PELANGGARAN VIEW (Component) -->
                    <div v-if="currentView === 'pelanggaran'" class="h-full w-full">
                        <pelanggaran-view :pelanggaran-form="pelanggaranForm"
                            :pelanggaran-santri-search="pelanggaranSantriSearch"
                            :pelanggaran-filtered-santri-options="pelanggaranFilteredSantriOptions"
                            :is-pelanggaran-santri-dropdown-open="isPelanggaranSantriDropdownOpen"
                            :pelanggaran-selected-santri-name="pelanggaranSelectedSantriName" :ui-data="uiData"
                            :editing-id="editingId" :filtered-pelanggaran="filteredPelanggaran"
                            :active-dropdown="activeDropdown"
                            @update:pelanggaran-form="Object.assign(pelanggaranForm, $event)"
                            @update:pelanggaran-santri-search="pelanggaranSantriSearch = $event"
                            @update:is-pelanggaran-santri-dropdown-open="isPelanggaranSantriDropdownOpen = $event"
                            @select-santri="selectPelanggaranSantri" @toggle-dropdown="toggleDropdown"
                            @edit-pelanggaran="editPelanggaran" @delete-pelanggaran="deletePelanggaran"
                            @submit-pelanggaran="submitPelanggaran" @cancel-edit="cancelEditPelanggaran"
                            @update-points="updatePelanggaranPoints" @open-master-modal="(props) => { 
                            const p = openMasterPelanggaranModal(props); 
                            modalState.view = 'master_pelanggaran'; 
                            modalState.title = p.title; 
                            modalState.isEdit = p.isEdit; 
                            modalState.isOpen = true; 
                        }" @delete-master="deleteMasterPelanggaran"></pelanggaran-view>
                    </div>



                </main>

                <!-- BOTTOM NAV (Mobile) -->
                <nav v-if="bottomMenus.length > 0"
                    class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-[50] h-16 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] pb-safe">
                    <div class="flex h-full w-full relative">
                        <template v-for="menu in bottomMenus" :key="menu.id">
                            <!-- Highlighted Item (Center) -->
                            <div v-if="menu.highlight" class="w-1/5 flex justify-center items-center relative">
                                <div class="floating-btn-wrapper">
                                    <button @click="navigateTo(menu.id)" class="floating-btn">
                                        <span class="material-symbols-outlined text-[32px]">{{ menu.icon }}</span>
                                    </button>
                                </div>
                            </div>
                            <!-- Standard Item -->
                            <button v-else @click="navigateTo(menu.id)"
                                class="w-1/5 flex flex-col items-center justify-center active:scale-95 transition-transform"
                                :class="currentView === menu.id ? 'active' : 'text-slate-400'">
                                <span class="material-symbols-outlined text-[30px]">{{ menu.icon }}</span>
                            </button>
                        </template>
                        <!-- Logout Button -->

                    </div>
                </nav>

            </div>
        </div>

        <!-- MONITORING MODAL -->
        <div v-if="monitoringModalOpen"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[60] p-4"
            @click.self="closeMonitoringModal">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 space-y-4 max-h-[85vh] flex flex-col shadow-2xl">
                <div class="flex justify-between items-center border-b border-slate-100 pb-4">
                    <div>
                        <h3 class="font-bold text-lg text-slate-900">Laporan Monitoring</h3>
                        <p class="text-xs text-slate-500">{{ formatDateFriendly(new Date()) }}</p>
                    </div>
                    <button @click="closeMonitoringModal"
                        class="size-8 flex items-center justify-center hover:bg-slate-100 rounded-full transition">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto space-y-4 pl-3 pr-1 custom-scrollbar">
                    <div v-if="notificationCount === 0" class="text-center py-12 text-slate-400">
                        <span class="material-symbols-outlined text-5xl opacity-20">check_circle</span>
                        <p class="mt-4 text-sm font-medium">Tidak ada laporan santri belum setor.</p>
                    </div>

                    <div v-else class="space-y-4 pb-4">
                        <div v-for="item in missingReports" :key="item.id"
                            class="flex items-start gap-3 relative pl-4 border-l-2 border-slate-100 last:border-0 pb-4 last:pb-0 group">
                            <!-- Timeline dot -->
                            <div
                                class="absolute -left-[5px] top-1.5 size-2.5 rounded-full border-2 border-white ring-1 ring-slate-200 bg-red-500 group-hover:scale-110 transition">
                            </div>

                            <div class="flex-1">
                                <p class="font-bold text-slate-900 text-sm group-hover:text-primary transition">{{
                                    item.santri_name }}</p>
                                <p class="text-xs text-slate-500 mt-0.5">{{ item.msg }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAPEL MODAL FORM -->
        <div v-if="mapelModalState.isOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
            @click.self="closeMapelModal">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 space-y-4">
                <h3 class="font-bold text-lg text-slate-900">{{ mapelModalState.title }}</h3>

                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-1">Nama Mata Pelajaran</label>
                    <input v-model="mapelForm.name" type="text" placeholder="Matematika, Bahasa Arab, dll"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                        required>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" @click="closeMapelModal"
                        class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">
                        Batal
                    </button>
                    <button @click="saveMapel"
                        class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">
                        Simpan
                    </button>
                </div>
            </div>
        </div>

        <!-- KELAS MODAL FORM -->
        <div v-if="kelasModalState.isOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
            @click.self="closeKelasModal">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 space-y-4">
                <h3 class="font-bold text-lg text-slate-900">{{ kelasModalState.title }}</h3>

                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-1">Nama Kelas</label>
                    <input v-model="kelasForm.name" type="text" placeholder="Kelas A, Kelas B, Ruang 1, dll"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                        required>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" @click="closeKelasModal"
                        class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">
                        Batal
                    </button>
                    <button @click="saveKelas"
                        class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">
                        Simpan
                    </button>
                </div>
            </div>
        </div>

        <!-- JADWAL MODAL FORM -->


        <!-- ABSENSI MODAL FORM (Removed duplicate) -->

        <!-- TARGET MODAL -->
        <div v-if="targetModalState.isOpen" @click.self="closeTargetModal()"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div @click.stop
                class="bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[85vh] overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-indigo-50 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-slate-900">Atur Target Bulanan</h3>
                    <button @click="closeTargetModal()"
                        class="size-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-red-500 transition"><span
                            class="material-symbols-outlined">close</span></button>
                </div>

                <!-- Modal Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- Santri Info -->
                    <div class="flex items-center gap-3 mb-5 bg-blue-50 p-3 rounded-xl border border-blue-100">
                        <div
                            class="size-10 bg-white rounded-full flex items-center justify-center font-bold text-blue-600 shadow-sm">
                            {{ targetForm.full_name.charAt(0) }}
                        </div>
                        <div class="min-w-0">
                            <p class="font-bold text-slate-900 text-sm truncate">{{ targetForm.full_name }}</p>
                            <p class="text-[10px] text-slate-500 uppercase font-bold">Total Hafalan: {{
                                targetForm.hafalan_desc }}</p>
                        </div>
                    </div>

                    <!-- Sabaq Input -->
                    <div class="mb-5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Target Sabaq (Hafalan
                            Baru)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" v-model.number="targetForm.sabaq"
                                class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center text-lg">
                            <div class="text-xs font-bold text-slate-400 whitespace-nowrap">Hal/Bulan</div>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">*Hafalan baru yang harus disetor setiap bulan</p>
                    </div>

                    <!-- Manzil Input -->
                    <div class="mb-5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Target Manzil
                            (Murojaah)</label>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-1">
                                <label
                                    class="text-[9px] font-bold text-slate-400 uppercase text-center block mb-1">Persen
                                    %</label>
                                <input type="number" v-model.number="targetForm.pct"
                                    @input="recalcManzil(targetForm.pct)"
                                    class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center">
                            </div>
                            <div class="col-span-2">
                                <label
                                    class="text-[9px] font-bold text-slate-400 uppercase text-center block mb-1">Target
                                    Halaman</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" v-model.number="targetForm.manzil"
                                        class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center text-lg">
                                    <div class="text-xs font-bold text-slate-400">Hal</div>
                                </div>
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">*Total Hafalan: {{ targetForm.totalPages }} Halaman
                        </p>
                    </div>

                    <!-- Save Button -->
                    <button @click="saveTarget()"
                        class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-primary/30 hover:bg-blue-800 transition">
                        Simpan Target
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL OVERLAY -->
        <div v-if="modalState.isOpen"
            class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
            <div
                class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden max-h-[90vh] flex flex-col transform transition-all scale-100">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="font-bold text-lg text-slate-800">{{ modalState.title }}</h3>
                    <button @click="closeModal"
                        class="size-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-red-500 transition"><span
                            class="material-symbols-outlined">close</span></button>
                </div>

                <!-- Modal Content -->
                <div class="p-6 overflow-y-auto">

                    <!-- FORM SANTRI -->
                    <form v-if="modalState.view === 'santri-form'" @submit.prevent="saveSantri" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">NIS (Otomatis)</label>
                                <input v-model="santriForm.nis" type="text"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-700 font-bold focus:outline-none focus:border-primary"
                                    readonly>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Kelas</label>
                                <select v-model="santriForm.class_id"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                    <option value="">Pilih Kelas</option>
                                    <option v-for="k in uiData.kelas" :value="k.name">{{ k.name }}</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Nama Lengkap</label>
                            <input v-model="santriForm.full_name" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary bg-white"
                                placeholder="Nama lengkap santri" required>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Username (Opsional)</label>
                            <input v-model="santriForm.username" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary bg-white"
                                placeholder="Username untuk login alternatif">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Jenis Kelamin</label>
                                <select v-model="santriForm.gender"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                    <option value="L">Laki-laki</option>
                                    <option value="P">Perempuan</option>
                                </select>
                            </div>
                        </div>

                        <!-- Informasi Wali -->
                        <div class="pt-4 border-t border-slate-100">
                            <h4 class="text-xs font-bold text-slate-800 mb-3">Informasi Wali</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <input v-model="santriForm.parent_name" type="text"
                                    class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-primary bg-white text-sm"
                                    placeholder="Nama Wali">
                                <input v-model="santriForm.parent_phone" type="text"
                                    class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-primary bg-white text-sm"
                                    placeholder="No. HP / WA">
                            </div>
                            <div class="mt-3">
                                <label class="block text-xs font-bold text-slate-700 mb-1">Password Wali (Login)</label>
                                <input v-model="santriForm.password" type="password"
                                    class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-primary bg-white text-sm"
                                    placeholder="Isi untuk ubah password">
                            </div>
                        </div>

                        <!-- Target Hafalan Removed -->

                        <div class="pt-4 flex gap-3">
                            <button type="button" @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button type="submit"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan</button>
                        </div>
                    </form>

                    <!-- FORM GURU -->
                    <form v-if="modalState.view === 'guru'" @submit.prevent="saveGuru" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Nama Lengkap</label>
                            <input v-model="guruForm.full_name" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                                required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Nomor Induk Guru (NIG)</label>
                            <input v-model="guruForm.username" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                                placeholder="Generated ID" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Username (Opsional)</label>
                            <input v-model="guruForm.custom_username" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                                placeholder="Username alternatif">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Password</label>
                            <input v-model="guruForm.password" type="password"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                                placeholder="Biarkan kosong jika tidak diubah">
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button type="button" @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button type="submit"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan</button>
                        </div>
                    </form>

                    <!-- FORM JADWAL -->
                    <form v-if="modalState.view === 'jadwal'" @submit.prevent="saveJadwal" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Hari</label>
                            <select v-model="jadwalForm.day"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                <option v-for="d in ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Ahad']"
                                    :value="d">{{ d }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Peruntukan</label>
                            <select v-model="jadwalForm.gender"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                <option value="L">Putra</option>
                                <option value="P">Putri</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Mata Pelajaran</label>
                            <select v-model="jadwalForm.mapel"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                <option value="">Pilih Mapel</option>
                                <option v-for="m in uiData.mapel" :value="m.name">{{ m.name }}</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Mulai</label>
                                <input v-model="jadwalForm.time_start" type="time"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Selesai</label>
                                <input v-model="jadwalForm.time_end" type="time"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Kelas</label>
                                <select v-model="jadwalForm.class_name"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                    <option value="">Pilih Kelas</option>
                                    <option v-for="k in uiData.kelas" :value="k.name">{{ k.name }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Guru</label>
                                <select v-model="jadwalForm.teacher"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                    <option value="">Pilih Guru</option>
                                    <option v-for="g in uiData.guru" :value="g.full_name">{{ g.full_name }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="pt-4 flex gap-3">
                            <button type="button" @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button type="submit"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan</button>
                        </div>
                    </form>

                    <!-- FORM ABSENSI -->
                    <div v-if="modalState.view === 'absensi'" class="space-y-4">
                        <!-- Info Jadwal -->
                        <div v-if="absensiState.activeJadwal"
                            class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-slate-900">{{ absensiState.activeJadwal.mapel }}</h4>
                                    <p class="text-xs text-slate-500 font-mono">{{ absensiState.activeJadwal.class_name
                                        }} &bull; {{ absensiState.activeJadwal.time }}</p>
                                    <p class="text-xs text-slate-500 mt-1">{{ absensiState.activeJadwal.teacher }}</p>
                                </div>
                                <div
                                    class="bg-white px-2 py-1 rounded-lg border text-xs font-bold text-slate-500 shadow-sm">
                                    {{ absensiState.santriList.length }} Santri
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions -->
                        <div class="flex gap-2 overflow-x-auto pb-2">
                            <button type="button" @click="setAllAbsensi('H')"
                                class="px-3 py-1.5 rounded-lg bg-green-50 text-green-700 text-xs font-bold border border-green-200 hover:bg-green-100">Semua
                                Hadir</button>
                            <button type="button" @click="setAllAbsensi('S')"
                                class="px-3 py-1.5 rounded-lg bg-yellow-50 text-yellow-700 text-xs font-bold border border-yellow-200 hover:bg-yellow-100">Semua
                                Sakit</button>
                            <button type="button" @click="setAllAbsensi('I')"
                                class="px-3 py-1.5 rounded-lg bg-blue-50 text-blue-700 text-xs font-bold border border-blue-200 hover:bg-blue-100">Semua
                                Izin</button>
                            <button type="button" @click="setAllAbsensi('A')"
                                class="px-3 py-1.5 rounded-lg bg-red-50 text-red-700 text-xs font-bold border border-red-200 hover:bg-red-100">Semua
                                Alpha</button>
                        </div>

                        <!-- Santri List -->
                        <div class="space-y-2 max-h-[400px] overflow-y-auto pr-1">
                            <div v-for="s in absensiState.santriList" :key="s._id"
                                class="flex items-center justify-between p-3 rounded-xl border border-slate-100 hover:border-slate-200 transition bg-slate-50/50">
                                <div>
                                    <p class="font-bold text-slate-800 text-sm">{{ s.full_name }}</p>
                                    <p class="text-[10px] text-slate-400">{{ s.nis || '-' }}</p>
                                </div>
                                <div class="flex gap-1 bg-white p-1 rounded-lg border shadow-sm">
                                    <button type="button" @click="updateSantriStatus(s._id, 'H')"
                                        class="size-8 rounded-md flex items-center justify-center font-bold text-xs transition-all"
                                        :class="formState[s._id] === 'H' ? 'bg-green-500 text-white shadow' : 'text-slate-400 hover:bg-slate-50'">H</button>
                                    <button type="button" @click="updateSantriStatus(s._id, 'S')"
                                        class="size-8 rounded-md flex items-center justify-center font-bold text-xs transition-all"
                                        :class="formState[s._id] === 'S' ? 'bg-yellow-500 text-white shadow' : 'text-slate-400 hover:bg-slate-50'">S</button>
                                    <button type="button" @click="updateSantriStatus(s._id, 'I')"
                                        class="size-8 rounded-md flex items-center justify-center font-bold text-xs transition-all"
                                        :class="formState[s._id] === 'I' ? 'bg-blue-500 text-white shadow' : 'text-slate-400 hover:bg-slate-50'">I</button>
                                    <button type="button" @click="updateSantriStatus(s._id, 'A')"
                                        class="size-8 rounded-md flex items-center justify-center font-bold text-xs transition-all"
                                        :class="formState[s._id] === 'A' ? 'bg-red-500 text-white shadow' : 'text-slate-400 hover:bg-slate-50'">A</button>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="pt-4 flex gap-3 border-t border-slate-50">
                            <button type="button" @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button type="button" @click="saveAbsensi().then(ok => { if(ok) closeModal(); })"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan
                                Absensi</button>
                        </div>
                    </div>

                    <!-- FORM TARGET -->
                    <div v-if="modalState.view === 'target-form'" class="space-y-4">
                        <div class="flex items-center gap-3 mb-2 bg-blue-50 p-3 rounded-xl border border-blue-100">
                            <div
                                class="size-10 bg-white rounded-full flex items-center justify-center font-bold text-blue-600 shadow-sm">
                                {{ getInitials(targetForm.full_name) }}</div>
                            <div>
                                <p class="font-bold text-slate-900 text-sm">{{ targetForm.full_name }}</p>
                                <p class="text-[10px] text-slate-500 uppercase font-bold">Total Hafalan: {{
                                    targetForm.hafalan_desc }}</p>
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Target Sabaq
                                (Hafalan Baru)</label>
                            <div class="flex items-center gap-2">
                                <input v-model.number="targetForm.sabaq" type="number"
                                    class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center text-lg">
                                <div class="text-xs font-bold text-slate-400">Hal/Bulan</div>
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Target Manzil
                                (Murojaah)</label>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="col-span-1">
                                    <label
                                        class="text-[9px] font-bold text-slate-400 uppercase text-center block mb-1">Persen
                                        %</label>
                                    <input v-model.number="targetForm.pct" @input="recalcManzil" type="number"
                                        class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center">
                                </div>
                                <div class="col-span-2">
                                    <label
                                        class="text-[9px] font-bold text-slate-400 uppercase text-center block mb-1">Target
                                        Halaman</label>
                                    <div class="flex items-center gap-2">
                                        <input v-model.number="targetForm.manzil" type="number"
                                            class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center text-lg">
                                        <div class="text-xs font-bold text-slate-400">Hal</div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-1">*Total Hafalan: {{ targetForm.totalPages }}
                                Halaman</p>
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button @click="saveTarget"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan
                                Target</button>
                        </div>
                    </div>

                    <!-- FORM MASTER PELANGGARAN -->
                    <div v-if="modalState.view === 'master_pelanggaran'" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Nama Pelanggaran</label>
                            <input v-model="masterPelanggaranForm.name" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                                placeholder="Contoh: Terlambat, Tidak Piket" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Poin Pengurang</label>
                            <input v-model="masterPelanggaranForm.points" type="number"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                                required>
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button type="button" @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button type="button"
                                @click="saveMasterPelanggaran().then(res => { if(res && res.success) closeModal(); })"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan</button>
                        </div>
                    </div>

                    <!-- GRADING MODAL -->
                    <div v-if="modalState.view === 'grading'" class="space-y-6">
                        <!-- Manual Score Input -->
                        <div
                            class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100 flex items-center justify-between">
                            <div class="flex flex-col">
                                <label class="font-bold text-slate-700 text-sm">Nilai Manual</label>
                                <span class="text-[10px] text-slate-500 uppercase font-black">Skala 0-100</span>
                            </div>
                            <input v-model.number="ujianForm.s_score_manual" type="number" min="0" max="100"
                                class="w-24 px-3 py-3 text-center font-bold text-xl rounded-xl border border-slate-200 focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>

                        <!-- Grade Buttons Grid -->
                        <div class="space-y-3">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Pilih
                                Predikat</label>
                            <div class="grid grid-cols-3 gap-2">
                                <!-- Helper to set grade -->
                                <button v-for="g in ['A+', 'A', 'B+', 'B', 'B-', 'C']" :key="g" @click="setGrade(g)"
                                    class="py-3 rounded-xl border-2 font-bold transition flex items-center justify-center text-sm"
                                    :class="ujianForm.s_grade === g ? 'bg-primary text-white border-primary shadow-lg' : 'bg-white text-slate-600 border-slate-100 hover:border-blue-200'">
                                    {{ g }}
                                </button>
                            </div>

                            <!-- Centang Special Case (Only visible in Hafalan mode) -->
                            <button v-if="currentView === 'hafalan'" @click="setGrade('Centang')"
                                class="w-full mt-2 p-3 rounded-xl border-2 font-bold transition flex items-center justify-center gap-2"
                                :class="ujianForm.s_grade === 'Centang' ? 'bg-orange-500 text-white border-orange-500 shadow-lg' : 'bg-white text-orange-500 border-orange-100 hover:border-orange-200 text-sm'">
                                <span class="material-symbols-outlined text-xl">check_circle</span> Selesai
                            </button>
                        </div>

                        <!-- Reset / Delete -->
                        <div class="pt-4 border-t">
                            <button @click="setGrade(null); submitUjian()"
                                class="w-full p-3 rounded-xl border border-red-100 text-red-500 font-bold hover:bg-red-50 flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined">delete</span> Hapus
                            </button>
                        </div>

                        <!-- Save & Nav Buttons -->
                        <div class="flex flex-col gap-2 pt-2">
                            <button @click="submitUjian(); closeModal()"
                                class="w-full py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition flex items-center justify-center gap-2">
                                Simpan
                            </button>

                            <button @click="selectUjianJuz(ujianForm.s_juz, true)"
                                class="w-full py-3 rounded-xl bg-slate-800 text-white font-bold hover:bg-slate-900 transition flex items-center justify-center gap-2">
                                Lihat Al-Qur'an
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>



        <!--  Guru Modal Form -->


        <!-- CROP MODAL -->
        <div v-if="cropModal.isOpen"
            class="fixed inset-0 z-[70] bg-black/90 flex items-center justify-center p-4 fade-in">
            <div class="bg-white rounded-2xl overflow-hidden shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
                <div class="p-4 bg-white flex justify-between items-center border-b z-10">
                    <h3 class="font-bold text-lg text-slate-800">Sesuaikan Foto</h3>
                    <button @click="cancelCrop"
                        class="size-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-red-500 transition"><span
                            class="material-symbols-outlined">close</span></button>
                </div>
                <div class="flex-1 overflow-hidden bg-black flex items-center justify-center relative">
                    <img ref="cropperImage" :src="cropModal.imageSrc"
                        class="max-w-full max-h-[60vh] block object-contain">
                </div>
                <div class="p-4 bg-white border-t z-10 flex gap-3">
                    <button @click="cancelCrop"
                        class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                    <button @click="saveCrop"
                        class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan
                        Foto</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Core Logic -->
    <script src="js/core.js"></script>
    <script src="js/utils_date.js"></script>
    <script src="js/utils_password.js"></script>
    <script src="js/utils_quran.js"></script>

    <!-- Composables (load before main app) -->
    <script src="js/composables/useAuth.js"></script>
    <script src="js/composables/usePelanggaran.js"></script>
    <script src="js/composables/useSantri.js"></script> <!-- PDF & Excel Libs (v34) -->


    <!-- Composables -->
    <script src="js/composables/useRekap.js"></script>
    <script src="js/composables/useGuru.js"></script>
    <script src="js/composables/useMapel.js"></script>
    <script src="js/composables/useKelas.js"></script>
    <script src="js/composables/useJadwal.js"></script>
    <script src="js/composables/useAbsensi.js"></script>
    <script src="js/composables/useTarget.js"></script>
    <script src="js/composables/useUjian.js"></script>
    <script src="js/composables/useRiwayat.js"></script>
    <script src="js/composables/useSetoran.js"></script>
    <script src="js/composables/useQuran.js"></script>
    <script src="js/composables/useDashboard.js"></script>
    <script src="js/composables/useProfile.js"></script>

    <!-- Main App -->
    <!-- Components -->
    <script src="js/components/LoginView.js"></script>
    <script src="js/components/PelanggaranView.js"></script>
    <script src="js/components/DashboardView.js"></script>
    <script src="js/components/SantriView.js"></script>
    <script src="js/components/GuruView.js"></script>
    <script src="js/components/UjianView.js"></script>
    <script src="js/components/SetoranView.js"></script>
    <script src="js/components/TargetView.js"></script>
    <script src="js/components/RekapView.js"></script>
    <script src="js/components/RiwayatView.js"></script>
    <script src="js/components/JadwalView.js"></script>
    <script src="js/components/AbsensiView.js"></script>
    <script src="js/components/ProfileView.js"></script>
    <script src="js/composables/useMonitoring.js"></script>
    <script src="js/app_vue.js"></script>

    <!-- Service Worker Registration -->
    <script>
        // PWA Install Logic
        let deferredPrompt;
        window.isPWAInstalled = false;

        if (window.matchMedia('(display-mode: standalone)').matches) {
            window.isPWAInstalled = true;
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            console.log("PWA Install Prompt captured");

            // Dispatch custom event to notify Vue components
            window.dispatchEvent(new CustomEvent('pwa-install-available'));
        });

        window.addEventListener('appinstalled', () => {
            deferredPrompt = null;
            window.isPWAInstalled = true;
            console.log('PWA was installed');
        });

        window.installPWA = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
        };

        // UI Toast for Update
        function showUpdateNotification() {
            const toast = document.createElement('div');
            toast.id = 'pwa-update-toast';
            toast.className = 'fixed bottom-4 left-4 right-4 md:left-auto md:right-8 md:w-96 bg-slate-900 text-white p-4 rounded-xl shadow-2xl flex items-center justify-between z-[100] animate-in slide-in-from-bottom duration-300';
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-yellow-400">system_update</span>
                    <div>
                        <p class="font-bold text-sm">Versi Baru Tersedia</p>
                        <p class="text-xs text-slate-300">Aplikasi akan diperbarui.</p>
                    </div>
                </div>
                <button id="pwa-update-btn" class="px-3 py-1.5 bg-primary text-white text-xs font-bold rounded-lg hover:bg-blue-600 transition">
                    Update
                </button>
            `;
            document.body.appendChild(toast);

            document.getElementById('pwa-update-btn').addEventListener('click', () => {
                if (newWorker) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
                toast.remove();
            });
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js?v=3.2').then(reg => {
                    console.log('SW Registered!', reg);

                    // 1. Check if update is already waiting (e.g. from previous visit)
                    if (reg.waiting) {
                        newWorker = reg.waiting;
                        showUpdateNotification();
                    }

                    // 2. Listen for new updates found
                    reg.addEventListener('updatefound', () => {
                        newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New content is available; please refresh.
                                showUpdateNotification();
                            }
                        });
                    });
                }).catch(err => console.log('SW Fail', err));

                // 3. Reload page when new SW takes control
                let refreshing;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    window.location.reload();
                    refreshing = true;
                });
            });
        }
    </script>
</body>

</html>