<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem E-Umar</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E40AF',
                        secondary: '#64748B',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
</head>

<body class="bg-slate-50 text-slate-800 h-screen w-full overflow-hidden">
    <div id="app" v-cloak class="w-full h-full flex flex-col relative text-sm">

        <!-- LOGIN VIEW (Redesigned) -->
        <div v-if="currentView === 'login'"
            class="w-full h-full flex flex-col md:flex-row bg-slate-50 relative overflow-hidden">

            <!-- DESKTOP LEFT: Branding -->
            <div
                class="hidden md:flex md:w-1/2 lg:w-3/5 relative bg-primary items-center justify-center overflow-hidden">
                <!-- Gradients -->
                <div class="absolute inset-0 bg-gradient-to-br from-blue-900 via-blue-700 to-indigo-800 opacity-90">
                </div>
                <!-- Decorative Circles -->
                <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-white/10 rounded-full blur-3xl">
                </div>
                <div
                    class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-indigo-500/20 rounded-full blur-3xl">
                </div>

                <div class="relative z-10 text-white max-w-lg p-12">
                    <h1 class="text-5xl font-black mb-6 tracking-tight leading-tight">{{ appName }}</h1>
                    <p class="text-blue-100 text-lg leading-relaxed font-medium">Sistem Manajemen Akademik Ma'had Umar
                        Bin Khattab</p>
                    <div class="mt-8 flex gap-3">
                        <div class="w-16 h-1.5 rounded-full bg-white/30"></div>
                        <div class="w-4 h-1.5 rounded-full bg-white/10"></div>
                        <div class="w-4 h-1.5 rounded-full bg-white/10"></div>
                    </div>
                </div>
            </div>

            <!-- RIGHT / MOBILE: Login Form -->
            <div class="w-full md:w-[45%] lg:w-[40%] h-full flex flex-col justify-center p-6 relative">

                <!-- Mobile Top Gradient (Taller & Cleaner) -->
                <div
                    class="md:hidden absolute top-0 left-0 right-0 h-[45vh] bg-gradient-to-br from-blue-700 to-indigo-800 rounded-b-[3rem] shadow-blue-900/20 shadow-xl overflow-hidden">
                    <div class="absolute top-[-50px] right-[-50px] w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                    <div class="absolute bottom-10 left-[-20px] w-32 h-32 bg-indigo-500/20 rounded-full blur-2xl"></div>
                </div>

                <div class="w-full max-w-sm mx-auto relative z-10 md:mt-0">
                    <!-- Mobile Brand Text -->
                    <div class="md:hidden mb-8 text-white px-2 text-center">
                        <!-- Icon Removed -->
                        <h2 class="text-3xl font-black tracking-tight">{{ appName }}</h2>
                        <p class="text-blue-50 text-sm mt-2 font-medium">Sistem Manajemen Akademik<br>Ma'had Umar Bin
                            Khattab</p>
                    </div>

                    <!-- Login Card -->
                    <div
                        class="bg-white md:bg-transparent rounded-[1rem] md:rounded-none shadow-2xl md:shadow-none p-6 md:p-0 border border-slate-100 md:border-none">
                        <div class="mb-8 hidden md:block">
                            <h2 class="text-3xl font-bold text-slate-800">Assalamu'alaikum!</h2>
                            <p class="text-slate-500 mt-2 font-medium">Silahkan masuk</p>
                        </div>

                        <!-- Mobile Title inside Card -->
                        <div class="mb-6 md:hidden text-center">
                            <h2 class="text-xl font-bold text-slate-800">Assalamu'alaikum!</h2>
                            <p class="text-slate-400 text-xs font-bold mt-1">Silahkan masuk</p>
                        </div>

                        <form @submit.prevent="handleLogin" class="space-y-4">
                            <div>

                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors text-[20px]">person</span>
                                    <input type="text" v-model="loginForm.username"
                                        class="w-full pl-11 pr-4 py-3.5 rounded-2xl border border-slate-200 focus:outline-none focus:border-primary focus:ring-4 focus:ring-blue-500/10 bg-slate-50/50 font-bold text-slate-700 transition-all placeholder:font-normal placeholder:text-slate-400"
                                        placeholder="Username / NIG / NIS">
                                </div>
                            </div>
                            <div>

                                <div class="relative group">
                                    <span
                                        class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors text-[20px]">lock</span>
                                    <input type="password" v-model="loginForm.password"
                                        class="w-full pl-11 pr-4 py-3.5 rounded-2xl border border-slate-200 focus:outline-none focus:border-primary focus:ring-4 focus:ring-blue-500/10 bg-slate-50/50 font-bold text-slate-700 transition-all placeholder:font-normal placeholder:text-slate-400"
                                        placeholder="••••••••">
                                </div>
                            </div>

                            <button type="submit"
                                class="w-full bg-primary text-white py-4 rounded-2xl font-bold text-lg hover:bg-blue-800 transform active:scale-[0.98] transition-all shadow-lg shadow-blue-900/20 mt-2 flex items-center justify-center gap-2">
                                <span>Masuk</span>
                                <span class="material-symbols-outlined text-xl">arrow_forward</span>
                            </button>
                        </form>

                        <!-- Mobile Footer -->
                        <div class="mt-8 text-center md:hidden">
                            <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase">E-Umar {{
                                appVersion }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN APP VIEW -->
        <div v-else class="flex h-full w-full">

            <!-- SIDEBAR (Desktop) -->
            <aside v-if="isSidebarVisible"
                class="hidden md:flex flex-col w-64 bg-white border-r border-slate-200 h-full fixed left-0 top-0 z-30 shadow-sm">
                <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg">
                        <span class="material-symbols-outlined">school</span>
                    </div>
                    <div>
                        <h1 class="text-slate-900 font-bold text-lg leading-none">{{ appName }}</h1>
                        <p class="text-slate-500 text-xs mt-1">Ver. {{ appVersion }}</p>
                    </div>
                </div>
                <div class="flex-1 p-4 space-y-1 overflow-y-auto">
                    <button v-for="menu in myMenus" :key="menu.id" @click="navigateTo(menu.id)"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium text-sm"
                        :class="currentView === menu.id ? 'bg-primary text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'">
                        <span class="material-symbols-outlined">{{ menu.icon }}</span>
                        {{ menu.label }}
                    </button>
                    <!-- LOGOUT (Sidebar) -->
                    <button @click="logout"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-500 hover:bg-red-50 font-medium text-sm mt-4">
                        <span class="material-symbols-outlined">logout</span> Keluar
                    </button>
                </div>
                <!-- User Profile -->
                <div class="p-4 border-t border-slate-100">
                    <div @click="navigateTo('profile')"
                        class="flex items-center gap-3 p-2 rounded-xl hover:bg-slate-50 cursor-pointer transition group">
                        <div
                            class="size-8 bg-blue-100 text-primary rounded-full flex items-center justify-center font-bold text-xs group-hover:bg-primary group-hover:text-white transition">
                            {{ getInitials(userSession.full_name) }}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <p class="text-xs font-bold text-slate-900 truncate group-hover:text-primary">{{
                                userSession.full_name }}</p>
                            <p class="text-[10px] text-slate-500 truncate">{{ userSession.role }}</p>
                        </div>
                        <span class="material-symbols-outlined text-slate-300 text-sm">settings</span>
                    </div>
                </div>
            </aside>

            <!-- MAIN CONTENT AREA -->
            <div class="flex-1 flex flex-col h-full md:pl-64 bg-slate-50 relative w-full">

                <!-- MOBILE HEADER -->
                <header v-if="isHeaderVisible"
                    class="md:hidden fixed top-0 left-0 right-0 z-40 bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 h-16 flex items-center justify-between shadow-sm">
                    <div class="flex items-center gap-2">
                        <!-- Logo Removed -->
                        <h2 class="font-bold text-slate-800 text-lg tracking-tight">{{ appName }}</h2>
                    </div>
                    <!-- Optional: Right Header Items (e.g. Profile) -->
                    <!-- Sync Indicator & Profile -->
                    <div class="flex items-center gap-2">
                        <!-- QURAN MENU BUTTON (Only in Quran View) -->
                        <button v-if="currentView === 'quran'" @click="quranState.showDrawer = true"
                            class="mr-2 text-slate-600 hover:text-primary transition flex items-center">
                            <span class="material-symbols-outlined text-2xl">menu</span>
                        </button>

                        <!-- Sync Status -->
                        <div v-if="syncState.status === 'uploading'"
                            class="flex items-center justify-center size-8 bg-blue-50 rounded-full border border-blue-100">
                            <span
                                class="material-symbols-outlined text-[20px] text-primary animate-pulse">cloud_upload</span>
                        </div>
                        <div v-else-if="syncState.status === 'saved'"
                            class="flex items-center justify-center size-8 bg-green-50 rounded-full border border-green-100 fade-in">
                            <span class="material-symbols-outlined text-[20px] text-green-600">cloud_done</span>
                        </div>
                    </div>
                </header>

                <!-- SCROLLABLE CONTENT -->
                <main class="flex-1 w-full md:transition-all" :class="[
                        currentView === 'quran' ? 'p-0 h-full overflow-hidden' : 'overflow-y-auto px-4 pb-24 md:px-6 md:py-6 md:pb-8',
                        isHeaderVisible ? (currentView === 'quran' ? 'pt-20 md:pt-0' : 'pt-20') : ''
                    ]">

                    <!-- DASHBOARD VIEW -->
                    <div v-if="currentView === 'dashboard'" class="fade-in">

                        <!-- Greeting Card -->
                        <div @click="navigateTo('profile')"
                            class="bg-white p-5 rounded-3xl border border-slate-100 card-shadow mb-6 flex items-center gap-4 cursor-pointer hover:bg-slate-50 transition active:scale-95 group">
                            <!-- Photo or Initials -->
                            <div v-if="userSession.photo_url"
                                class="size-12 rounded-full overflow-hidden border border-slate-100 group-hover:border-primary transition">
                                <img :src="userSession.photo_url" alt="Profile" class="w-full h-full object-cover"
                                    referrerpolicy="no-referrer">
                            </div>
                            <div v-else
                                class="size-12 rounded-full bg-blue-50 flex items-center justify-center text-primary font-bold text-xl group-hover:bg-primary group-hover:text-white transition">
                                {{ getInitials(userSession.full_name) }}
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-900 group-hover:text-primary transition">Ahlan,
                                    {{ userSession.full_name.split(' ')[0] }}!</h2>
                                <p class="text-xs text-slate-500">Selamat datang kembali</p>
                            </div>
                        </div>

                        <!-- Menu Grid -->
                        <div class="grid grid-cols-4 gap-3 mb-6">
                            <button v-for="menu in myMenus.filter(m => m.id !== 'logout')" :key="menu.id"
                                @click="navigateTo(menu.id)" class="flex flex-col items-center gap-2 group">
                                <div class="menu-icon-box w-14 h-14 flex items-center justify-center rounded-2xl transition-all shadow-sm border border-slate-100 bg-white group-hover:shadow-md group-active:scale-95"
                                    :class="menu.id === 'input' ? 'bg-blue-50 border-blue-200' : ''">
                                    <span class="material-symbols-outlined text-2xl"
                                        :class="menu.id === 'input' ? 'text-primary' : 'text-slate-600'">{{ menu.icon
                                        }}</span>
                                </div>
                                <span class="text-[11px] font-medium text-slate-600 text-center leading-tight">{{
                                    menu.label }}</span>
                            </button>
                        </div>

                        <!-- Wali View -->
                        <div v-if="userSession.role === 'wali' && dashboardStats.waliData"
                            class="bg-primary rounded-3xl p-6 text-white shadow-lg mb-4">
                            <h2 class="text-xl font-bold">Progress Hafalan</h2>
                            <div class="flex gap-4 mt-4">
                                <div class="flex-1 bg-white/10 rounded-xl p-3 text-center">
                                    <p class="text-xs opacity-70">Sabaq</p>
                                    <p class="text-2xl font-bold">{{ dashboardStats.waliData.sabaqPercent.toFixed(0) }}%
                                    </p>
                                </div>
                                <div class="flex-1 bg-white/10 rounded-xl p-3 text-center">
                                    <p class="text-xs opacity-70">Manzil</p>
                                    <p class="text-2xl font-bold">{{ dashboardStats.waliData.manzilPercent.toFixed(0)
                                        }}%</p>
                                </div>
                            </div>
                        </div>

                        <!-- Admin/Guru View -->
                        <div v-else>
                            <!-- Stats Cards -->
                            <div class="mb-6">
                                <!-- Total Santri (Consolidated) -->
                                <div @click="currentView = 'santri'"
                                    class="bg-white p-5 rounded-2xl border card-shadow cursor-pointer hover:bg-slate-50 transition group">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="text-xs font-bold text-slate-400 mb-1">TOTAL SANTRI</p>
                                            <p class="text-4xl font-black text-slate-900">{{ dashboardStats.totalSantri
                                                }}</p>
                                        </div>
                                        <div class="text-right flex flex-col gap-1">
                                            <p class="text-xs font-bold text-slate-500">
                                                Putra: <span class="text-blue-600 ml-1 text-sm">{{
                                                    dashboardStats.totalPutra }}</span>
                                            </p>
                                            <p class="text-xs font-bold text-slate-500">
                                                Putri: <span class="text-pink-500 ml-1 text-sm">{{
                                                    dashboardStats.totalPutri }}</span>
                                            </p>
                                        </div>
                                    </div>


                                </div>
                            </div>

                            <!-- Charts Grid -->
                            <!-- Top Santri Leaderboard -->
                            <div class="bg-white p-5 rounded-3xl border card-shadow mb-6">
                                <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-yellow-500">trophy</span>
                                    Top 5 Santri (Nilai Rekap)
                                </h3>
                                <div class="space-y-3">
                                    <div v-for="(s, idx) in dashboardStats.topSantri" :key="idx"
                                        class="flex items-center gap-3 p-3 rounded-xl border border-slate-50 bg-slate-50/50">
                                        <div class="size-8 rounded-full flex items-center justify-center font-bold text-sm"
                                            :class="{
                                                'bg-yellow-100 text-yellow-700': idx === 0,
                                                'bg-slate-200 text-slate-600': idx > 0
                                            }">
                                            {{ idx + 1 }}
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-bold text-slate-800 text-sm truncate">{{ s.name }}</p>
                                            <p class="text-xs text-slate-500">{{ s.class }}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-black text-primary text-sm">{{ s.total.toFixed(1) }}</p>
                                            <p class="text-[10px] text-slate-400">Total Nilai</p>
                                        </div>
                                    </div>
                                    <div v-if="dashboardStats.topSantri.length === 0"
                                        class="text-center text-slate-400 text-xs py-2">
                                        Belum ada data
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activity Feed -->
                            <div class="bg-white p-5 rounded-3xl border card-shadow mb-8">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-slate-900">Aktivitas Terbaru</h3>
                                </div>
                                <!-- Filter Pills -->
                                <div class="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">
                                    <button @click="activityFilter = 'all'"
                                        :class="activityFilter === 'all' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600'"
                                        class="px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">
                                        Semua
                                    </button>
                                    <button @click="activityFilter = 'setoran'"
                                        :class="activityFilter === 'setoran' ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-600'"
                                        class="px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">
                                        Setoran
                                    </button>
                                    <button @click="activityFilter = 'ujian'"
                                        :class="activityFilter === 'ujian' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600'"
                                        class="px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">
                                        Ujian
                                    </button>
                                    <button @click="activityFilter = 'pelanggaran'"
                                        :class="activityFilter === 'pelanggaran' ? 'bg-red-600 text-white' : 'bg-slate-100 text-slate-600'"
                                        class="px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">
                                        Pelanggaran
                                    </button>
                                </div>

                                <!-- List -->
                                <div class="space-y-4 max-h-60 overflow-y-auto pl-3 pr-1 custom-scrollbar">
                                    <div v-for="(act, idx) in filteredActivities" :key="idx"
                                        class="flex items-start gap-3 relative pl-4 border-l-2 border-slate-100 last:border-0 pb-4 last:pb-0">
                                        <!-- Timeline dot -->
                                        <div class="absolute -left-[5px] top-1 size-2.5 rounded-full border-2 border-white ring-1 ring-slate-200 bg-slate-400"
                                            :class="{
                                                'bg-emerald-500': act.type === 'setoran',
                                                'bg-blue-500': act.type === 'ujian',
                                                'bg-red-500': act.type === 'pelanggaran'
                                            }"></div>

                                        <div class="flex-1">
                                            <p class="text-xs text-slate-400 mb-0.5">{{ formatDate(act.date) }}</p>
                                            <p class="text-xs font-bold text-slate-800">{{ act.desc }}</p>
                                        </div>
                                    </div>

                                    <div v-if="filteredActivities.length === 0"
                                        class="text-center py-6 text-slate-400 text-xs">
                                        Tidak ada aktivitas
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- SANTRI VIEW -->
                    <div v-if="currentView === 'santri'" class="fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Data Santri</h2>
                            <button @click="openSantriModal()"
                                class="bg-primary text-white px-4 py-2 rounded-xl flex items-center gap-2 text-sm font-bold shadow-lg shadow-blue-900/20 hover:bg-blue-800 transition">
                                <span class="material-symbols-outlined text-lg">add</span> Tambah
                            </button>
                        </div>

                        <!-- Search -->
                        <div
                            class="bg-white p-2 rounded-xl border border-slate-200 mb-2 flex items-center gap-2 transition focus-within:ring-2 focus-within:ring-primary/20 shadow-sm">
                            <span class="material-symbols-outlined text-slate-400 ml-2">search</span>
                            <input v-model="searchText" type="text" placeholder="Cari berdasarkan nama atau NIS..."
                                class="w-full bg-transparent outline-none text-sm placeholder:text-slate-400">
                        </div>

                        <!-- Gender Filter Tabs -->
                        <div class="flex p-1 bg-slate-100 rounded-xl mb-4">
                            <button @click="santriGenderFilter = 'L'"
                                :class="santriGenderFilter === 'L' ? 'bg-white text-blue-600 shadow-sm font-bold' : 'text-slate-500 hover:text-slate-700'"
                                class="flex-1 py-2 text-sm rounded-lg transition-all">
                                Putra
                            </button>
                            <button @click="santriGenderFilter = 'P'"
                                :class="santriGenderFilter === 'P' ? 'bg-white text-pink-500 shadow-sm font-bold' : 'text-slate-500 hover:text-slate-700'"
                                class="flex-1 py-2 text-sm rounded-lg transition-all">
                                Putri
                            </button>
                        </div>

                        <!-- List -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                            <div v-for="item in filteredSantri" :key="item._id"
                                class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center hover:border-blue-100 transition group">
                                <div class="flex gap-3 items-center">
                                    <div
                                        class="size-10 bg-blue-50 text-primary rounded-full flex items-center justify-center font-bold text-sm">
                                        {{ getInitials(item.full_name) }}</div>
                                    <div>
                                        <p class="font-bold text-slate-900 group-hover:text-primary transition">{{
                                            item.full_name }}</p>
                                        <p class="text-xs text-slate-500">{{ item.santri_id }} <span
                                                class="mx-1">•</span> {{
                                            item.kelas || '-' }}</p>
                                    </div>
                                </div>
                                <div class="relative">
                                    <button @click.stop="toggleDropdown(item._id)"
                                        class="size-8 flex items-center justify-center text-slate-300 hover:text-primary hover:bg-slate-50 rounded-full transition">
                                        <span class="material-symbols-outlined">more_vert</span>
                                    </button>

                                    <!-- Backdrop for click outside -->
                                    <div v-if="activeDropdown === item._id" class="fixed inset-0 z-10 cursor-default"
                                        @click.stop="toggleDropdown(null)"></div>

                                    <!-- Dropdown Menu -->
                                    <div v-if="activeDropdown === item._id"
                                        class="absolute right-0 top-8 w-32 bg-white border border-slate-100 shadow-xl rounded-xl z-20 flex flex-col py-1 overflow-hidden animate-in fade-in zoom-in-95 duration-100 origin-top-right">

                                        <a v-if="item.no_hp" :href="'https://wa.me/' + formatWANumber(item.no_hp)"
                                            target="_blank"
                                            class="flex items-center gap-2 px-4 py-1.5 text-xs font-bold text-slate-600 hover:bg-green-50 hover:text-green-600 transition text-left">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                fill="currentColor" class="bi bi-whatsapp text-green-500"
                                                viewBox="0 0 16 16">
                                                <path
                                                    d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z" />
                                            </svg> WhatsApp
                                        </a>

                                        <button @click="openSantriModal(item); toggleDropdown(null)"
                                            class="flex items-center gap-2 px-4 py-1.5 text-xs font-bold text-slate-600 hover:bg-blue-50 hover:text-blue-600 transition text-left w-full">
                                            <span class="material-symbols-outlined text-base">edit</span> Edit
                                        </button>

                                        <button @click="deleteSantri(item); toggleDropdown(null)"
                                            class="flex items-center gap-2 px-4 py-1.5 text-xs font-bold text-slate-600 hover:bg-red-50 hover:text-red-500 transition text-left w-full">
                                            <span class="material-symbols-outlined text-base">delete</span> Hapus
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Empty State -->
                            <div v-if="filteredSantri.length === 0" class="text-center py-10">
                                <span class="material-symbols-outlined text-slate-300 text-4xl mb-2">search_off</span>
                                <p class="text-slate-400 text-sm">Tidak ada data santri ditemukan.</p>
                            </div>
                        </div>
                    </div>

                    <!-- GURU VIEW -->
                    <div v-if="currentView === 'guru'" class="fade-in space-y-4 pb-32">
                        <div class="flex justify-between items-center px-2">
                            <h2 class="text-2xl font-bold text-slate-900">Data Guru</h2>
                            <button @click="openGuruModal()"
                                class="bg-primary text-white px-4 py-2 rounded-xl text-sm font-bold shadow flex items-center gap-2 hover:bg-blue-800 transition">
                                <span class="material-symbols-outlined text-lg">add</span> Tambah
                            </button>
                        </div>

                        <!-- Guru List -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 px-2">
                            <div v-for="user in filteredGuru" :key="user._id"
                                class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-start group hover:border-blue-100 transition">
                                <div>
                                    <p class="font-bold text-slate-900">{{ user.full_name }}</p>
                                    <p class="text-[10px] text-slate-500 uppercase font-mono tracking-wider">
                                        {{ user.username }}
                                        <span v-if="user.custom_username" class="text-blue-600"> • {{
                                            user.custom_username }}</span>
                                        • {{ user.role }}
                                    </p>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button @click="openGuruModal(user)"
                                        class="size-8 flex items-center justify-center rounded-full text-slate-400 hover:bg-slate-100 transition">
                                        <span class="material-symbols-outlined text-[20px]">edit</span>
                                    </button>
                                    <button @click="deleteGuru(user._id)"
                                        class="size-8 flex items-center justify-center rounded-full text-red-400 hover:bg-red-50 transition">
                                        <span class="material-symbols-outlined text-[20px]">delete</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div v-if="!filteredGuru || filteredGuru.length === 0"
                                class="bg-white p-8 rounded-xl border text-center">
                                <span class="material-symbols-outlined text-5xl text-slate-300 mb-2">groups</span>
                                <p class="text-slate-400 text-sm">Belum ada data guru</p>
                            </div>
                        </div>
                    </div>

                    <div>

                        <!-- UJIAN VIEW -->
                        <div v-if="currentView === 'ujian'" class="fade-in">
                            <h2 class="text-2xl font-bold mb-4">Ujian & Evaluasi</h2>

                            <!-- Tabs -->
                            <div class="bg-white p-2 rounded-xl border border-slate-100 card-shadow flex gap-2 mb-6">
                                <button @click="ujianForm.tab = 'bulanan'"
                                    :class="ujianForm.tab === 'bulanan' ? 'bg-primary text-white shadow' : 'text-slate-500 hover:bg-slate-50'"
                                    class="flex-1 py-3 rounded-xl text-sm font-bold transition-all">Ujian
                                    Bulanan</button>
                                <button @click="ujianForm.tab = 'semester'"
                                    :class="ujianForm.tab === 'semester' ? 'bg-primary text-white shadow' : 'text-slate-500 hover:bg-slate-50'"
                                    class="flex-1 py-3 rounded-xl text-sm font-bold transition-all">Ujian
                                    Semester</button>
                            </div>

                            <div class="grid md:grid-cols-3 gap-6">
                                <!-- Main Form -->
                                <div class="md:col-span-2 space-y-4">
                                    <div class="bg-white p-5 rounded-2xl border border-slate-100 card-shadow space-y-4">
                                        <h3 class="font-bold text-slate-800 border-b pb-2 mb-2">Form Input {{
                                            ujianForm.tab
                                            ===
                                            'bulanan' ? 'Bulanan' : 'Semester' }}</h3>

                                        <!-- Common Fields -->
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-xs font-bold text-slate-700 mb-1">Jenis
                                                    Ujian</label>
                                                <select
                                                    v-model="ujianForm[ujianForm.tab === 'bulanan' ? 'b_type' : 's_type']"
                                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 font-bold text-sm focus:outline-none focus:border-primary">
                                                    <option value="quran">Ujian Al-Quran</option>
                                                    <option value="mapel">Ujian Pelajaran</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-xs font-bold text-slate-700 mb-1">Santri</label>
                                                <select v-model="ujianForm.santri_id"
                                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white font-bold text-sm focus:outline-none focus:border-primary">
                                                    <option value="">Pilih Santri</option>
                                                    <option v-for="s in uiData.santri" :value="s.santri_id">{{
                                                        s.full_name
                                                        }}
                                                    </option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- BULANAN FORM -->
                                        <div v-if="ujianForm.tab === 'bulanan'" class="space-y-4 pt-2">
                                            <!-- Bulanan Quran -->
                                            <div v-if="ujianForm.b_type === 'quran'" class="space-y-4">
                                                <div v-if="selectedSantriBulananStats"
                                                    class="bg-blue-50 rounded-xl p-4 border border-blue-100">
                                                    <div class="flex justify-between items-end mb-2">
                                                        <div>
                                                            <p
                                                                class="text-[10px] font-bold text-blue-400 uppercase tracking-wider">
                                                                Capaian Sabaq Bulan Ini</p>
                                                            <p
                                                                class="text-2xl font-black text-blue-700 leading-none mt-1">
                                                                {{ selectedSantriBulananStats.sabaq.current }} <span
                                                                    class="text-sm font-bold text-blue-400">/ {{
                                                                    selectedSantriBulananStats.sabaq.target }}
                                                                    Hal</span>
                                                            </p>
                                                        </div>
                                                        <button @click="startBulananExam"
                                                            class="size-10 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg shadow-blue-200 hover:scale-105 active:scale-95 transition">
                                                            <span class="material-symbols-outlined">play_arrow</span>
                                                        </button>
                                                    </div>
                                                    <!-- Progress Bar -->
                                                    <div class="w-full bg-blue-200 rounded-full h-2 overflow-hidden">
                                                        <div class="bg-blue-600 h-full rounded-full transition-all duration-500"
                                                            :style="{ width: selectedSantriBulananStats.sabaq.percent + '%' }">
                                                        </div>
                                                    </div>
                                                    <p class="text-[10px] text-blue-400 mt-2 italic text-center">
                                                        Materi ujian diambil dari awal setoran bulan ini
                                                    </p>
                                                </div>

                                                <div v-else
                                                    class="p-4 bg-slate-50 rounded-xl border border-slate-200 text-sm text-slate-400 italic text-center">
                                                    Pilih santri untuk melihat progress sabaq.
                                                </div>
                                                <div class="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label class="block text-xs font-bold text-slate-400 mb-1">JML
                                                            SOAL</label>
                                                        <input v-model="ujianForm.b_soal" @input="calcBulananScore"
                                                            type="number"
                                                            class="w-full px-4 py-2 rounded-xl border border-slate-200 font-bold text-center">
                                                    </div>
                                                    <div>
                                                        <label
                                                            class="block text-xs font-bold text-slate-400 mb-1">SALAH</label>
                                                        <input v-model="ujianForm.b_salah" @input="calcBulananScore"
                                                            type="number"
                                                            class="w-full px-4 py-2 rounded-xl border border-slate-200 font-bold text-center text-red-500">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Bulanan Mapel -->
                                            <div v-else>
                                                <label class="block text-xs font-bold text-slate-400 mb-1">MATA
                                                    PELAJARAN</label>
                                                <select v-model="ujianForm.b_mapel"
                                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white text-sm">
                                                    <option v-for="m in mapelList" :value="m">{{ m }}</option>
                                                </select>
                                            </div>

                                            <!-- Score -->
                                            <div
                                                class="flex items-center justify-between pt-4 border-t border-slate-100">
                                                <span class="text-xs font-bold text-slate-500">NILAI AKHIR</span>
                                                <input v-if="ujianForm.b_type === 'quran'" :value="ujianForm.b_score"
                                                    readonly
                                                    class="w-32 px-4 py-2 rounded-xl border border-slate-200 font-black text-2xl text-right text-emerald-600 bg-slate-50">
                                                <input v-else v-model="ujianForm.b_score" type="number"
                                                    class="w-32 px-4 py-2 rounded-xl border border-slate-200 font-black text-2xl text-right text-emerald-600">
                                            </div>
                                        </div>

                                        <!-- SEMESTER FORM -->
                                        <div v-else class="space-y-4 pt-2">
                                            <!-- Semester Quran (Grid) -->
                                            <div v-if="ujianForm.s_type === 'quran'" class="space-y-4">
                                                <div v-if="!ujianForm.santri_id"
                                                    class="text-center py-8 text-slate-400 italic bg-slate-50 rounded-xl">
                                                    Pilih
                                                    Santri dahulu untuk melihat progres</div>
                                                <div v-else class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                                    <div class="flex justify-between items-center mb-3">
                                                        <h4
                                                            class="font-bold text-xs text-slate-500 flex items-center gap-2">
                                                            <span
                                                                class="material-symbols-outlined text-sm">grid_view</span>
                                                            Hafalan (Klik Juz untuk Ujian)
                                                        </h4>
                                                        <button v-if="ujianForm.s_juz"
                                                            @click="selectUjianJuz(ujianForm.s_juz, true)"
                                                            class="size-8 rounded-full bg-primary text-white flex items-center justify-center hover:bg-blue-800 transition shadow-md"
                                                            title="Mulai Ujian">
                                                            <span
                                                                class="material-symbols-outlined text-[20px]">play_arrow</span>
                                                        </button>
                                                    </div>
                                                    <div class="flex flex-wrap gap-2 justify-center">
                                                        <button v-for="j in 30" :key="j" @click="selectUjianJuz(j)"
                                                            class="size-9 rounded-full text-xs font-bold flex flex-col items-center justify-center transition-all shadow-sm border"
                                                            :class="[
                                                              ujianForm.s_juz === j ? 'ring-2 ring-offset-1 ring-primary scale-110 z-10' : '',
                                                              selectedSantriProgress[j] ? 
                                                                 (['A+','A'].includes(selectedSantriProgress[j]) ? 'bg-blue-500 text-white border-blue-600' : 
                                                                  selectedSantriProgress[j] === 'C' ? 'bg-red-500 text-white border-red-600' : 'bg-emerald-500 text-white border-emerald-600') 
                                                                 : 'bg-white text-slate-300 border-slate-200 hover:bg-slate-100'
                                                          ]">
                                                            {{ j }}
                                                            <span v-if="selectedSantriProgress[j]"
                                                                class="text-[8px] leading-none opacity-80 mt-[-2px]">{{
                                                                selectedSantriProgress[j] }}</span>
                                                        </button>
                                                    </div>
                                                </div>

                                                <div v-if="ujianForm.s_juz"
                                                    class="animate-scale-in bg-white border border-blue-100 p-4 rounded-xl shadow-sm">
                                                    <div class="flex justify-between items-center mb-2">
                                                        <span class="font-bold text-blue-800 text-sm">Penilaian Juz {{
                                                            ujianForm.s_juz }}</span>
                                                    </div>
                                                    <div class="flex items-center gap-4">
                                                        <div class="flex-1">
                                                            <label
                                                                class="block text-[10px] font-bold text-slate-400 mb-1">SALAH
                                                                (BARIS)</label>
                                                            <input v-model="ujianForm.s_salah"
                                                                @input="calcSemesterScore" type="number"
                                                                class="w-full px-4 py-2 rounded-xl border border-slate-200 font-bold text-center text-red-500 bg-slate-50">
                                                        </div>
                                                        <div class="flex-1">
                                                            <label
                                                                class="block text-[10px] font-bold text-slate-400 mb-1">NILAI
                                                                AKHIR</label>
                                                            <input :value="ujianForm.s_score" readonly
                                                                class="w-full px-4 py-2 rounded-xl border border-slate-200 font-black text-xl text-center text-emerald-600 bg-slate-50">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Semester Mapel -->
                                            <div v-else class="space-y-4">
                                                <div>
                                                    <label class="block text-xs font-bold text-slate-400 mb-1">MATA
                                                        PELAJARAN</label>
                                                    <select v-model="ujianForm.s_mapel"
                                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white text-sm">
                                                        <option v-for="m in mapelList" :value="m">{{ m }}</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-bold text-slate-400 mb-1">NILAI
                                                        AKHIR</label>
                                                    <input v-model="ujianForm.s_score" type="number"
                                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 font-black text-3xl text-right text-emerald-600">
                                                </div>
                                            </div>
                                        </div>

                                        <button @click="submitUjian"
                                            class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-900/20 hover:bg-blue-800 transition active:scale-95 flex items-center justify-center gap-2 mt-4">
                                            <span class="material-symbols-outlined">save</span> Simpan Nilai {{
                                            ujianForm.tab ===
                                            'bulanan' ? 'Bulanan' : 'Semester' }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Sidebar History -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 card-shadow h-fit">
                                    <h3
                                        class="font-bold border-b border-slate-100 pb-3 mb-3 text-sm flex items-center gap-2">
                                        <span class="material-symbols-outlined text-slate-400 text-sm">history</span>
                                        Riwayat {{
                                        ujianForm.tab === 'bulanan' ? 'Bulanan' : 'Semester' }}
                                    </h3>
                                    <div class="space-y-3">
                                        <div v-for="u in filteredUjian" :key="u._id"
                                            class="flex justify-between items-center text-sm border-b border-slate-50 pb-2 last:border-0 hover:bg-slate-50 p-1 rounded transition">
                                            <div>
                                                <p class="font-bold text-slate-800 text-xs">{{
                                                    getSantriName(u.santri_id) }}
                                                </p>
                                                <p class="text-[10px] text-slate-500">{{ formatDate(u.date) }} • {{
                                                    u.detail
                                                    ||
                                                    u.type }}</p>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold"
                                                    :class="u.score >= 60 ? 'text-emerald-600' : 'text-red-500'">
                                                    {{ u.score }}</div>
                                                <div v-if="u.grade"
                                                    class="text-[10px] font-bold bg-slate-100 px-1 rounded text-slate-600 inline-block">
                                                    {{ u.grade }}</div>
                                            </div>
                                        </div>
                                        <div v-if="filteredUjian.length === 0"
                                            class="text-center py-4 text-slate-400 text-xs">
                                            Belum ada data.
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- PELANGGARAN VIEW -->
                        <div v-if="currentView === 'pelanggaran'" class="fade-in">
                            <h2 class="text-2xl font-bold mb-4">Pelanggaran & Kedisiplinan</h2>

                            <!-- Tabs -->
                            <div class="bg-white p-2 rounded-xl border border-slate-100 card-shadow flex gap-2 mb-6">
                                <button @click="pelanggaranForm.tab = 'input'"
                                    :class="pelanggaranForm.tab === 'input' ? 'bg-primary text-white shadow' : 'text-slate-500 hover:bg-slate-50'"
                                    class="flex-1 py-3 rounded-xl text-sm font-bold transition-all">Input
                                    Pelanggaran</button>
                                <button @click="pelanggaranForm.tab = 'jenis'"
                                    :class="pelanggaranForm.tab === 'jenis' ? 'bg-primary text-white shadow' : 'text-slate-500 hover:bg-slate-50'"
                                    class="flex-1 py-3 rounded-xl text-sm font-bold transition-all">Input Jenis
                                    Pelanggaran</button>
                            </div>

                            <div class="grid md:grid-cols-3 gap-6">

                                <!-- TAB 1: INPUT PELANGGARAN -->
                                <template v-if="pelanggaranForm.tab === 'input'">
                                    <!-- Input Form -->
                                    <div class="md:col-span-2 space-y-4">
                                        <div
                                            class="bg-white p-5 rounded-2xl border border-slate-100 card-shadow space-y-4">
                                            <h3 class="font-bold text-slate-800 border-b pb-2 mb-2">Input Pelanggaran
                                                Baru
                                            </h3>

                                            <!-- Santri Select -->
                                            <div>
                                                <label
                                                    class="block text-xs font-bold text-slate-700 mb-1">Santri</label>
                                                <select v-model="pelanggaranForm.santri_id"
                                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white font-bold text-sm focus:outline-none focus:border-primary">
                                                    <option value="">Pilih Santri</option>
                                                    <option v-for="s in uiData.santri" :value="s.santri_id">{{
                                                        s.full_name
                                                        }}
                                                    </option>
                                                </select>
                                            </div>

                                            <!-- Date & Points -->
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-700 mb-1">Tanggal</label>
                                                    <input v-model="pelanggaranForm.date" type="date"
                                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 font-bold text-sm">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-bold text-slate-700 mb-1">Poin
                                                        Pengurangan</label>
                                                    <input v-model="pelanggaranForm.points" type="number"
                                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 font-bold text-sm text-red-500">
                                                </div>
                                            </div>

                                            <!-- Description / Type (Dropdown) -->
                                            <div>
                                                <label class="block text-xs font-bold text-slate-700 mb-1">Jenis
                                                    Pelanggaran</label>
                                                <select v-model="pelanggaranForm.description"
                                                    @change="updatePelanggaranPoints"
                                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white font-bold text-sm focus:outline-none focus:border-primary">
                                                    <option value="">Pilih Jenis Pelanggaran...</option>
                                                    <option v-for="m in uiData.master_pelanggaran" :value="m.name">{{
                                                        m.name
                                                        }}
                                                        ({{ m.points }} Poin)</option>
                                                </select>
                                            </div>

                                            <!-- Submit -->
                                            <button @click="submitPelanggaran"
                                                class="w-full bg-red-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-900/20 hover:bg-red-600 transition active:scale-95 flex items-center justify-center gap-2 mt-2">
                                                <span class="material-symbols-outlined">warning</span> Simpan
                                                Pelanggaran
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Sidebar Column (Master & History) -->
                                    <div class="space-y-4">
                                        <!-- Master Data Moved to Tab 2 -->

                                        <!-- History Sidebar -->
                                        <div class="bg-white p-4 rounded-2xl border border-slate-100 card-shadow h-fit">
                                            <h3
                                                class="font-bold border-b border-slate-100 pb-3 mb-3 text-sm flex items-center gap-2">
                                                <span
                                                    class="material-symbols-outlined text-slate-400 text-sm">history</span>
                                                Riwayat Terbaru
                                            </h3>
                                            <div class="space-y-3">
                                                <div v-for="p in filteredPelanggaran" :key="p._id"
                                                    class="flex justify-between items-start text-sm border-b border-slate-50 pb-2 last:border-0 hover:bg-slate-50 p-1 rounded transition">
                                                    <div class="flex-1 pr-2">
                                                        <p class="font-bold text-slate-800 text-xs">{{
                                                            getSantriName(p.santri_id) }}
                                                        </p>
                                                        <p class="text-[10px] text-slate-400">{{ formatDate(p.date) }}
                                                        </p>
                                                        <p class="text-[11px] text-slate-600 italic line-clamp-2 mt-1">
                                                            {{
                                                            p.description }}</p>
                                                    </div>
                                                    <div class="flex flex-col items-end gap-1">
                                                        <div class="font-bold text-red-500 text-xs whitespace-nowrap">
                                                            -{{
                                                            p.points
                                                            }}</div>
                                                        <button @click="deletePelanggaran(p._id)"
                                                            class="text-slate-300 hover:text-red-500">
                                                            <span
                                                                class="material-symbols-outlined text-[16px]">delete</span>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div v-if="filteredPelanggaran.length === 0"
                                                    class="text-center py-4 text-slate-400 text-xs">
                                                    Belum ada data.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- TAB 2: INPUT JENIS PELANGGARAN -->
                                <template v-if="pelanggaranForm.tab === 'jenis'">
                                    <div class="md:col-span-3">
                                        <div class="bg-white p-5 rounded-2xl border border-slate-100 card-shadow h-fit">
                                            <h3
                                                class="font-bold border-b border-slate-100 pb-3 mb-3 text-lg flex items-center gap-2">
                                                <span class="material-symbols-outlined text-slate-600">settings</span>
                                                Kelola Jenis Pelanggaran Master
                                            </h3>

                                            <!-- Add Form -->
                                            <div
                                                class="space-y-4 mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                                <h4 class="font-bold text-sm text-slate-600 mb-2">Tambah Baru</h4>
                                                <div class="flex flex-col md:flex-row gap-4">
                                                    <input v-model="masterPelanggaranForm.name"
                                                        placeholder="Nama Pelanggaran Baru (Contoh: Tidak Piket)"
                                                        class="flex-1 px-4 py-3 rounded-xl border border-slate-200 text-sm">
                                                    <input v-model="masterPelanggaranForm.points" type="number"
                                                        placeholder="Poin"
                                                        class="w-full md:w-32 px-4 py-3 rounded-xl border border-slate-200 text-sm text-center">
                                                    <button @click="saveMasterPelanggaran"
                                                        class="bg-slate-800 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-700 shadow-lg">Tambah</button>
                                                </div>
                                            </div>

                                            <!-- List -->
                                            <div class="space-y-1">
                                                <h4 class="font-bold text-sm text-slate-600 mb-3">Daftar Jenis
                                                    Pelanggaran
                                                </h4>
                                                <div v-for="m in uiData.master_pelanggaran" :key="m._id"
                                                    class="flex justify-between items-center text-sm border-b border-slate-50 py-3 first:pt-0 last:border-0 hover:bg-slate-50 px-2 rounded transition">
                                                    <span class="font-bold text-slate-700">{{ m.name }}</span>
                                                    <div class="flex items-center gap-4">
                                                        <span
                                                            class="font-bold text-red-500 bg-red-50 px-3 py-1 rounded-full text-xs">-{{
                                                            m.points }} Poin</span>
                                                        <button @click="deleteMasterPelanggaran(m._id)"
                                                            class="text-slate-300 hover:text-red-500 bg-white border border-slate-200 p-1 rounded-lg">
                                                            <span
                                                                class="material-symbols-outlined text-[16px]">close</span>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div v-if="uiData.master_pelanggaran.length === 0"
                                                    class="text-center text-slate-400 text-sm py-8 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                                                    Belum ada jenis pelanggaran yang dibuat.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>




                        <!-- JADWAL VIEW -->
                        <div v-if="currentView === 'jadwal'" class="fade-in">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">Jadwal KBM</h2>
                                <button @click="openJadwalModal()"
                                    class="bg-primary text-white px-4 py-2 rounded-xl flex items-center gap-2 text-sm font-bold shadow-lg shadow-blue-900/20 hover:bg-blue-800 transition">
                                    <span class="material-symbols-outlined text-lg">add</span> Tambah
                                </button>
                            </div>

                            <!-- Gender Filter -->
                            <div class="flex p-1 bg-slate-100 rounded-xl mb-4">
                                <button @click="jadwalGenderFilter = 'L'"
                                    :class="jadwalGenderFilter === 'L' ? 'bg-white text-blue-600 shadow-sm font-bold' : 'text-slate-500 hover:text-slate-700'"
                                    class="flex-1 py-2 text-xs rounded-lg transition-all">
                                    Putra
                                </button>
                                <button @click="jadwalGenderFilter = 'P'"
                                    :class="jadwalGenderFilter === 'P' ? 'bg-white text-pink-500 shadow-sm font-bold' : 'text-slate-500 hover:text-slate-700'"
                                    class="flex-1 py-2 text-xs rounded-lg transition-all">
                                    Putri
                                </button>
                            </div>

                            <!-- Day Filter -->
                            <div class="flex gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar">
                                <button
                                    v-for="day in ['Semua', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Ahad']"
                                    @click="setDayFilter(day)"
                                    class="px-4 py-2 rounded-xl font-bold text-sm whitespace-nowrap transition-colors border"
                                    :class="dayFilter.value === day ? 'bg-primary text-white border-primary shadow-md' : 'bg-white text-slate-500 border-slate-100 hover:bg-slate-50'">
                                    {{ day }}
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                                <div v-for="j in filteredJadwalList" :key="j._id"
                                    class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm transition hover:border-blue-100">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <span
                                                    class="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-50 text-blue-600 uppercase">{{
                                                    j.day }}</span>
                                                <span
                                                    class="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-100 text-slate-500">{{
                                                    j.time }}</span>
                                            </div>
                                            <h3 class="font-bold text-slate-900 group-hover:text-primary transition">
                                                {{
                                                j.mapel }}</h3>
                                            <p class="text-xs text-slate-500 font-bold mt-1">Kelas {{
                                                j.class_name }} •
                                                {{
                                                j.teacher }}</p>
                                        </div>
                                        <div class="flex gap-1">
                                            <button @click="openJadwalModal(j)"
                                                class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition"><span
                                                    class="material-symbols-outlined text-lg">edit</span></button>
                                            <button @click="deleteJadwal(j._id)"
                                                class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition"><span
                                                    class="material-symbols-outlined text-lg">delete</span></button>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="filteredJadwalList.length === 0" class="text-center py-12 text-slate-400">
                                    <span class="material-symbols-outlined text-4xl mb-2">calendar_month</span>
                                    <p class="text-sm font-bold">Tidak ada jadwal.</p>
                                </div>
                            </div>
                        </div>

                        <!-- ABSENSI VIEW -->
                        <div v-if="currentView === 'absensi'" class="fade-in">
                            <!-- Header -->
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h2 class="text-2xl font-bold text-slate-900">Absensi Harian</h2>
                                    <p class="text-xs text-slate-500">Rekap kehadiran santri per mata pelajaran</p>
                                </div>
                            </div>

                            <!-- Gender Filter -->
                            <div class="flex p-1 bg-slate-100 rounded-xl mb-4">
                                <button @click="genderFilter = 'L'"
                                    :class="genderFilter === 'L' ? 'bg-white text-blue-600 shadow-sm font-bold' : 'text-slate-500 hover:text-slate-700'"
                                    class="flex-1 py-2 text-xs rounded-lg transition-all">
                                    Putra
                                </button>
                                <button @click="genderFilter = 'P'"
                                    :class="genderFilter === 'P' ? 'bg-white text-pink-500 shadow-sm font-bold' : 'text-slate-500 hover:text-slate-700'"
                                    class="flex-1 py-1.5 text-xs rounded-lg transition-all">
                                    Putri
                                </button>
                            </div>

                            <!-- Date Navigator (Sticky) -->
                            <div class="bg-white p-3 rounded-xl border shadow-sm mb-4 sticky top-0 z-20">
                                <div class="flex items-center gap-2">
                                    <button @click="changeAbsensiDate(-1)"
                                        class="size-10 rounded-xl bg-gradient-to-br from-slate-50 to-slate-100 border border-slate-200 flex items-center justify-center text-slate-600 hover:from-blue-50 hover:to-blue-100 hover:border-blue-200 hover:text-blue-600 transition-all shadow-sm">
                                        <span class="material-symbols-outlined">chevron_left</span>
                                    </button>

                                    <div class="flex-1 bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 rounded-xl flex items-center justify-center py-2.5 relative shadow-inner cursor-pointer group"
                                        @click="$refs.dateInputAbs.showPicker()">
                                        <span class="text-sm font-bold text-slate-700 tracking-wide">
                                            {{ absensiDayName }}/{{ absensiState.dateFilter.split('-')[2] }}/{{
                                            absensiState.dateFilter.split('-')[1] }}/{{
                                            absensiState.dateFilter.split('-')[0] }}
                                        </span>
                                        <input ref="dateInputAbs" type="date" v-model="absensiState.dateFilter"
                                            class="absolute inset-0 opacity-0 cursor-pointer">
                                    </div>

                                    <button @click="changeAbsensiDate(1)"
                                        class="size-10 rounded-xl bg-gradient-to-br from-slate-50 to-slate-100 border border-slate-200 flex items-center justify-center text-slate-600 hover:from-blue-50 hover:to-blue-100 hover:border-blue-200 hover:text-blue-600 transition-all shadow-sm">
                                        <span class="material-symbols-outlined">chevron_right</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Jadwal Cards (Simplified & Clean) -->
                            <div class="space-y-4 pb-20">
                                <div v-for="j in dailyJadwal" :key="j._id" @click="openAbsensiPage(j)"
                                    class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md hover:border-slate-200 transition-all cursor-pointer group relative overflow-hidden">

                                    <!-- Left Accent Stripe -->
                                    <div class="absolute left-0 top-0 bottom-0 w-1 transition-colors"
                                        :class="getAbsensiForJadwal(j._id) ? 'bg-green-500' : 'bg-slate-200 group-hover:bg-blue-500'">
                                    </div>

                                    <div class="pl-3">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <h4
                                                    class="font-bold text-slate-900 text-lg group-hover:text-blue-600 transition-colors">
                                                    {{ j.mapel }}</h4>
                                                <p class="text-xs text-slate-500 font-mono mt-0.5">{{ j.class_name }} •
                                                    {{ j.teacher }}</p>
                                            </div>
                                            <div
                                                class="text-xs font-bold font-mono text-slate-500 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">
                                                {{ j.time }}
                                            </div>
                                        </div>

                                        <!-- Status Indicator -->
                                        <div v-if="getAbsensiForJadwal(j._id)"
                                            class="mt-4 pt-3 border-t border-slate-50">
                                            <div class="flex gap-4">
                                                <div class="flex flex-col items-center">
                                                    <span class="text-sm font-bold text-green-600">{{
                                                        getAbsensiSummary(getAbsensiForJadwal(j._id).details).H
                                                        }}</span>
                                                    <span
                                                        class="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Hadir</span>
                                                </div>
                                                <div class="flex flex-col items-center">
                                                    <span class="text-sm font-bold text-yellow-600">{{
                                                        getAbsensiSummary(getAbsensiForJadwal(j._id).details).S
                                                        }}</span>
                                                    <span
                                                        class="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Sakit</span>
                                                </div>
                                                <div class="flex flex-col items-center">
                                                    <span class="text-sm font-bold text-blue-600">{{
                                                        getAbsensiSummary(getAbsensiForJadwal(j._id).details).I
                                                        }}</span>
                                                    <span
                                                        class="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Izin</span>
                                                </div>
                                                <div class="flex flex-col items-center">
                                                    <span class="text-sm font-bold text-red-600">{{
                                                        getAbsensiSummary(getAbsensiForJadwal(j._id).details).A
                                                        }}</span>
                                                    <span
                                                        class="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Alpha</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div v-else
                                            class="mt-4 flex items-center gap-2 text-slate-400 group-hover:text-blue-500 transition-colors">
                                            <span class="material-symbols-outlined text-lg">edit_square</span>
                                            <span class="text-xs font-bold">Isi Absensi</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- No Jadwal State -->
                                <div v-if="!dailyJadwal || dailyJadwal.length === 0" class="text-center py-20">
                                    <div
                                        class="inline-flex size-20 rounded-full bg-slate-50 items-center justify-center mb-4">
                                        <span
                                            class="material-symbols-outlined text-4xl text-slate-300">calendar_month</span>
                                    </div>
                                    <h3 class="font-bold text-slate-700">Tidak ada Jadwal</h3>
                                    <p class="text-sm text-slate-400 mt-1">Hari ini libur atau tidak ada KBM.</p>
                                </div>
                            </div>
                        </div>

                        <!-- INPUT/SETORAN VIEW -->
                        <div v-if="currentView === 'input'" class="fade-in pb-48">
                            <h2 class="text-2xl font-bold mb-5">Input Setoran</h2>

                            <div class="bg-white p-6 rounded-3xl border shadow-sm space-y-5">
                                <!-- Santri Dropdown -->
                                <div>
                                    <label class="text-xs font-bold text-slate-600 mb-1 block">Santri</label>
                                    <select v-model="setoranForm.santri_id"
                                        class="w-full p-2 border rounded-xl text-sm font-bold">
                                        <option value="">-- Pilih Santri --</option>
                                        <option v-for="s in santriOptions" :key="s._id" :value="s.santri_id">
                                            {{ s.full_name }}
                                        </option>
                                    </select>
                                </div>

                                <!-- Type Tabs -->
                                <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                    <label v-for="type in ['Sabaq', 'Sabqi', 'Robt', 'Manzil']" :key="type"
                                        class="flex-1 min-w-[70px]">
                                        <input type="radio" :value="type" v-model="setoranForm.setoran_type"
                                            @change="changeSetoranType(type)" class="peer hidden">
                                        <div
                                            class="py-2 text-center rounded-lg border text-sm font-bold text-slate-500 peer-checked:bg-primary peer-checked:text-white transition cursor-pointer">
                                            {{ type }}
                                        </div>
                                    </label>
                                </div>

                                <!-- FORM SABAQ -->
                                <div v-if="setoranForm.setoran_type === 'Sabaq'" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-xs font-bold text-slate-400">Dari Surat</label>
                                            <select v-model.number="setoranForm.surah_from"
                                                @change="syncSurah(); validateAyat('from')"
                                                class="w-full p-2 border rounded-xl text-sm">
                                                <option v-for="s in surahList" :key="s.no" :value="s.no">
                                                    {{ s.no }}. {{ s.latin }}
                                                </option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-400">Sampai Surat</label>
                                            <select v-model.number="setoranForm.surah_to" @change="validateAyat('to')"
                                                class="w-full p-2 border rounded-xl text-sm">
                                                <option v-for="s in surahList" :key="s.no" :value="s.no">
                                                    {{ s.no }}. {{ s.latin }}
                                                </option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-xs font-bold text-slate-400">Dari Ayat</label>
                                            <input type="number" v-model.number="setoranForm.ayat_from"
                                                @input="validateAyat('from')"
                                                class="w-full p-2 border rounded-xl text-center font-bold"
                                                placeholder="1">
                                            <p v-if="surahHints.from.visible"
                                                class="text-[10px] text-slate-400 mt-1 text-center">
                                                {{ surahHints.from.text }}
                                            </p>
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-400">Sampai Ayat</label>
                                            <input type="number" v-model.number="setoranForm.ayat_to"
                                                @input="validateAyat('to')"
                                                class="w-full p-2 border rounded-xl text-center font-bold"
                                                placeholder="10">
                                            <p v-if="surahHints.to.visible"
                                                class="text-[10px] text-slate-400 mt-1 text-center">
                                                {{ surahHints.to.text }}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- FORM MANZIL -->
                                <div v-if="setoranForm.setoran_type === 'Manzil'" class="space-y-3">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400">Opsi Input</label>
                                        <select v-model="setoranForm.manzil_mode" @change="toggleManzilMode()"
                                            class="w-full p-2 border rounded-xl font-bold">
                                            <option value="juz">Per Juz</option>
                                            <option value="page">Per Halaman</option>
                                        </select>
                                    </div>

                                    <!-- Juz Mode -->
                                    <div v-if="setoranForm.manzil_mode === 'juz'">
                                        <label class="text-xs font-bold text-slate-400">Juz</label>
                                        <select v-model.number="setoranForm.juz"
                                            @change="setoranForm.pages = 20; updateGrade()"
                                            class="w-full p-2 border rounded-xl font-bold">
                                            <option v-for="i in 30" :key="i" :value="i">Juz {{ i }}</option>
                                        </select>
                                    </div>

                                    <!-- Page Mode -->
                                    <div v-if="setoranForm.manzil_mode === 'page'" class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-xs font-bold text-slate-400">Dari Hal</label>
                                            <input type="number" v-model.number="setoranForm.page_from"
                                                @input="calcPagesFromRange()"
                                                class="w-full p-2 border rounded-xl text-center font-bold">
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-400">Sampai Hal</label>
                                            <input type="number" v-model.number="setoranForm.page_to"
                                                @input="calcPagesFromRange()"
                                                class="w-full p-2 border rounded-xl text-center font-bold">
                                        </div>
                                    </div>
                                </div>

                                <!-- AUTO INFO -->
                                <div v-if="autoCalcInfo.visible"
                                    class="bg-blue-50 p-3 rounded-xl border border-blue-100 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-blue-600">info</span>
                                    <p class="text-xs text-blue-800 font-medium" v-html="autoCalcInfo.text"></p>
                                </div>

                                <!-- SCORING -->
                                <div class="bg-slate-50 p-4 rounded-xl border space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <!-- Pages -->
                                        <div>
                                            <label class="text-xs font-bold text-slate-400">Halaman</label>
                                            <div class="flex items-center gap-2">
                                                <button @click="adjustValue('pages', -0.5)"
                                                    class="size-8 rounded-lg bg-white border shadow-sm font-bold text-slate-500">
                                                    -
                                                </button>
                                                <input type="number" v-model.number="setoranForm.pages"
                                                    @input="updateGrade()"
                                                    :readonly="setoranForm.setoran_type === 'Manzil' || setoranForm.setoran_type === 'Sabqi' || setoranForm.setoran_type === 'Robt'"
                                                    class="w-full bg-white p-2 border rounded-lg text-center font-bold"
                                                    :class="{ 'text-gray-400': setoranForm.setoran_type === 'Manzil' || setoranForm.setoran_type === 'Sabqi' || setoranForm.setoran_type === 'Robt' }">
                                                <button @click="adjustValue('pages', 0.5)"
                                                    class="size-8 rounded-lg bg-white border shadow-sm font-bold text-slate-500">
                                                    +
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Errors -->
                                        <div>
                                            <label class="text-xs font-bold text-slate-400">Salah</label>
                                            <div class="flex items-center gap-2">
                                                <button @click="adjustValue('errors', -1)"
                                                    class="size-8 rounded-lg bg-white border shadow-sm font-bold text-slate-500">
                                                    -
                                                </button>
                                                <input type="number" v-model.number="setoranForm.errors"
                                                    @input="updateGrade()"
                                                    class="w-full bg-white p-2 border rounded-lg text-center font-bold text-red-500">
                                                <button @click="adjustValue('errors', 1)"
                                                    class="size-8 rounded-lg bg-white border shadow-sm font-bold text-slate-500">
                                                    +
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- PREVIEW GRADE -->
                                    <div class="flex justify-between items-center pt-2 border-t">
                                        <span class="text-xs font-bold text-slate-400">Nilai & Grade</span>
                                        <div class="text-right">
                                            <span :class="{
                                                'text-emerald-600': setoranForm.grade.startsWith('A'),
                                                'text-blue-600': setoranForm.grade === 'B',
                                                'text-red-600': setoranForm.grade === 'C'
                                            }" class="text-3xl font-black">
                                                {{ setoranForm.grade }}
                                            </span>
                                            <span class="text-xs font-mono text-slate-400 block">
                                                {{ setoranForm.score.toFixed(1) }}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- META (Date/Time) -->
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="date" v-model="setoranForm.setoran_date"
                                        class="w-full p-2 border rounded-xl text-xs font-bold">
                                    <input type="time" v-model="setoranForm.setoran_time"
                                        class="w-full p-2 border rounded-xl text-xs font-bold">
                                </div>

                                <!-- Save Button -->
                                <button @click="saveSetoran()"
                                    class="w-full bg-primary text-white py-4 rounded-xl font-bold shadow-lg text-lg hover:bg-blue-800 transition">
                                    Simpan Setoran
                                </button>
                            </div>

                            <!-- Recent History -->
                            <div class="mt-6 mx-2">
                                <h3 class="font-bold text-slate-700 mb-2 px-1">Riwayat Setoran Terbaru</h3>
                                <div class="space-y-2">
                                    <!-- Recent Items -->
                                    <div v-for="r in recentSetoran" :key="r._id"
                                        class="bg-white p-3 rounded-xl border shadow-sm flex justify-between items-center">
                                        <div class="overflow-hidden flex-1">
                                            <div class="text-xs text-slate-400 font-bold mb-0.5">
                                                {{ formatDateLong(r.setoran_date) }} • {{ formatTime(r.setoran_time)
                                                }}
                                            </div>
                                            <div class="font-bold text-slate-800 text-sm truncate">
                                                {{ getSantriName(r.santri_id) }}
                                            </div>
                                            <div class="text-xs text-slate-500 font-medium truncate">
                                                {{ r.setoran_type }} • {{ formatSetoranDetail(r) }}
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 flex-shrink-0">
                                            <div :class="{
                                                'text-emerald-600': r.grade === 'A+',
                                                'text-blue-600': r.grade === 'B',
                                                'text-red-500': r.grade === 'C'
                                            }" class="font-black text-sm">
                                                {{ r.grade }}
                                            </div>
                                            <!-- 3 Dots Menu -->
                                            <div class="relative">
                                                <button @click.stop="toggleMenu(r._id)"
                                                    class="size-8 rounded-lg hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition">
                                                    <span class="material-symbols-outlined text-lg">more_vert</span>
                                                </button>
                                                <!-- Dropdown -->
                                                <div v-if="isMenuOpen(r._id)" @click.stop
                                                    class="absolute right-0 top-10 bg-white rounded-xl shadow-lg border z-50 py-1 min-w-[120px]">
                                                    <button @click="editSetoran(r); toggleMenu(r._id)"
                                                        class="w-full px-4 py-2 text-left text-sm hover:bg-blue-50 text-blue-600 flex items-center gap-2">
                                                        <span class="material-symbols-outlined text-lg">edit</span>
                                                        Edit
                                                    </button>
                                                    <button @click="deleteSetoran(r._id); toggleMenu(r._id)"
                                                        class="w-full px-4 py-2 text-left text-sm hover:bg-red-50 text-red-500 flex items-center gap-2">
                                                        <span class="material-symbols-outlined text-lg">delete</span>
                                                        Hapus
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Empty State -->
                                    <p v-if="!recentSetoran || recentSetoran.length === 0"
                                        class="text-center text-slate-400 text-xs py-4">
                                        Belum ada data setoran {{ setoranForm.setoran_type }} terbaru
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- TARGET VIEW -->
                        <div v-if="currentView === 'target'" class="fade-in">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h2 class="text-2xl font-bold">Target Bulanan</h2>
                                    <p class="text-xs text-slate-500">Atur target hafalan baru & murojaah.</p>
                                </div>
                            </div>

                            <!-- Search -->
                            <div class="bg-white p-3 rounded-xl border shadow-sm sticky top-0 z-20 mb-4">
                                <input type="text" v-model="riwayatState.search" placeholder="Cari Santri..."
                                    class="w-full p-2 bg-slate-50 border rounded-lg text-sm font-bold">
                            </div>

                            <div class="space-y-3 pb-20">
                                <div v-for="s in santriWithTarget.filter(x => x.full_name.toLowerCase().includes(riwayatState.search.toLowerCase()))"
                                    :key="s._id"
                                    class="bg-white p-4 rounded-2xl border shadow-sm flex justify-between items-center group relative hover:border-blue-100 transition">
                                    <div>
                                        <h4 class="font-bold text-slate-900">{{ s.full_name }}</h4>
                                        <p class="text-xs text-slate-500 font-mono mb-2">{{ s.kelas || '-' }} •
                                            Hafalan:
                                            {{
                                            s.hafalan_manual || '0 Juz' }}</p>
                                        <div
                                            class="flex gap-2 text-[10px] font-bold uppercase tracking-wider flex-wrap">
                                            <span
                                                class="bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100">Sabaq:
                                                {{ s.view_sabaq }} Hal</span>
                                            <span
                                                class="bg-purple-50 text-purple-600 px-2 py-1 rounded border border-purple-100">Manzil:
                                                {{ s.view_manzil }} Hal ({{ s.view_pct }}%)</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-1"
                                        v-if="userSession.role === 'guru' || userSession.role === 'admin'">
                                        <button @click="openTargetModal(s)"
                                            class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition"><span
                                                class="material-symbols-outlined text-lg">edit_square</span></button>
                                        <button @click="resetTarget(s._id)"
                                            class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition"><span
                                                class="material-symbols-outlined text-lg">restart_alt</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- RIWAYAT & REKAP VIEW -->
                        <div v-if="currentView === 'riwayat'" class="fade-in">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">Riwayat Setoran</h2>
                                <!-- Pagination -->
                                <div class="space-x-2">
                                    <button :disabled="riwayatState.page <= 1" @click="riwayatState.page--"
                                        class="px-3 py-1 rounded border bg-white disabled:opacity-50 text-xs font-bold hover:bg-slate-50">Prev</button>
                                    <span class="text-xs font-bold">{{ riwayatState.page }} / {{ riwayatTotalPages
                                        || 1
                                        }}</span>
                                    <button :disabled="riwayatState.page >= riwayatTotalPages"
                                        @click="riwayatState.page++"
                                        class="px-3 py-1 rounded border bg-white disabled:opacity-50 text-xs font-bold hover:bg-slate-50">Next</button>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-xl border border-slate-100 card-shadow mb-4 space-y-3">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-bold text-slate-400 uppercase">Dari
                                            Tanggal</label>
                                        <input v-model="riwayatState.startDate" type="date"
                                            class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm font-bold">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-bold text-slate-400 uppercase">Sampai
                                            Tanggal</label>
                                        <input v-model="riwayatState.endDate" type="date"
                                            class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm font-bold">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-bold text-slate-400 uppercase">Kategori</label>
                                        <select v-model="riwayatState.category"
                                            class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm font-bold bg-white">
                                            <option value="">Semua Kategori</option>
                                            <option value="setoran">Setoran Hafalan</option>
                                            <option value="ujian">Ujian</option>
                                            <option value="pelanggaran">Pelanggaran</option>
                                        </select>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-bold text-slate-400 uppercase">Santri</label>
                                        <select v-model="riwayatState.santriId"
                                            class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm font-bold bg-white">
                                            <option value="">Semua Santri</option>
                                            <option v-for="s in uiData.santri" :value="s.santri_id">{{ s.full_name
                                                }}
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl border shadow-sm overflow-hidden mb-20">
                                <!-- Bulk Action Bar -->
                                <div v-if="riwayatState.selectedIds.length > 0"
                                    class="p-2 pl-4 bg-red-50 border-b border-red-100 flex items-center animate-fade-in">
                                    <button @click="deleteSelected"
                                        class="text-xs bg-red-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-red-700 transition flex items-center gap-1 shadow-sm">
                                        <span class="material-symbols-outlined text-sm">delete</span>
                                        {{ riwayatState.selectedIds.length }} Data
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead
                                            class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] border-b">
                                            <tr>
                                                <th class="px-4 py-3 w-10 text-center">
                                                    <input type="checkbox" @change="toggleSelectAll(paginatedRiwayat)"
                                                        :checked="paginatedRiwayat.length > 0 && paginatedRiwayat.every(i => riwayatState.selectedIds.includes(i._id))"
                                                        class="rounded border-slate-300 text-primary focus:ring-primary">
                                                </th>
                                                <th class="px-4 py-3 whitespace-nowrap">Waktu</th>
                                                <th class="px-4 py-3 whitespace-nowrap">Santri</th>
                                                <th class="px-4 py-3 whitespace-nowrap">Jenis</th>
                                                <th class="px-4 py-3 whitespace-nowrap">Detail</th>
                                                <th class="px-4 py-3 whitespace-nowrap text-center">Nilai/Poin</th>
                                                <th class="px-4 py-3 whitespace-nowrap text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100">
                                            <tr v-for="item in paginatedRiwayat" :key="item._id"
                                                class="hover:bg-slate-50 transition"
                                                :class="item.__cat === 'pelanggaran' ? 'bg-red-50/30 hover:bg-red-50' : ''">
                                                <!-- Checkbox -->
                                                <td class="px-4 py-3 text-center">
                                                    <input type="checkbox"
                                                        :checked="riwayatState.selectedIds.includes(item._id)"
                                                        @change="toggleSelect(item._id)"
                                                        class="rounded border-slate-300 text-primary focus:ring-primary">
                                                </td>

                                                <!-- Waktu -->
                                                <td class="px-4 py-3 whitespace-nowrap">
                                                    <div class="font-bold text-slate-700 text-xs">{{
                                                        formatDateLong(item.date) }}</div>
                                                    <div class="text-[10px] text-slate-500 font-bold mt-0.5">{{
                                                        formatTime(item.time) }}</div>
                                                </td>

                                                <!-- Santri -->
                                                <td class="px-4 py-3 whitespace-nowrap">
                                                    <div class="font-bold text-xs">{{ getSantriName(item.santri_id)
                                                        }}
                                                    </div>
                                                </td>

                                                <!-- Jenis -->
                                                <td class="px-4 py-3 whitespace-nowrap">
                                                    <span class="text-[10px] font-bold uppercase"
                                                        :class="item.__cat === 'pelanggaran' ? 'text-red-500' : 'text-slate-500'">
                                                        {{ item.__cat === 'pelanggaran' ? 'PELANGGARAN' :
                                                        item.setoran_type
                                                        || item.type || 'UJIAN' }}
                                                    </span>
                                                </td>

                                                <!-- Detail -->
                                                <td class="px-4 py-3">
                                                    <div v-if="item.__cat === 'setoran'">
                                                        <div
                                                            class="font-bold text-slate-700 text-xs truncate max-w-[150px]">
                                                            {{ item.surah_from_latin ?
                                                            item.surah_from_latin.replace(/^\d+\.\s*/, '') :
                                                            (item.juz ?
                                                            'Juz ' + item.juz : (item.page_from ? 'Hal ' +
                                                            item.page_from :
                                                            'Manzil')) }}</div>
                                                        <div class="text-[10px] text-slate-500">{{ item.pages }} Hal
                                                        </div>
                                                    </div>
                                                    <div v-else-if="item.__cat === 'ujian'">
                                                        <div class="font-bold text-slate-700 text-xs">{{ item.type
                                                            }}
                                                        </div>
                                                        <div class="text-[10px] text-slate-500 truncate max-w-[150px]">
                                                            {{
                                                            item.detail || '-' }}</div>
                                                    </div>
                                                    <div v-else-if="item.__cat === 'pelanggaran'">
                                                        <div
                                                            class="font-bold text-red-600 text-xs truncate max-w-[150px]">
                                                            PELANGGARAN</div>
                                                        <div class="text-[10px] text-slate-500 truncate max-w-[150px]">
                                                            {{ item.description || '-' }}</div>
                                                    </div>
                                                </td>

                                                <!-- Nilai -->
                                                <td class="px-4 py-3 text-center">
                                                    <span v-if="item.__cat === 'setoran'"
                                                        class="px-2 py-1 rounded text-xs font-black"
                                                        :class="item.grade === 'A+' ? 'text-emerald-600 bg-emerald-50' : item.grade === 'C' ? 'text-red-600 bg-red-50' : 'text-blue-600 bg-blue-50'">
                                                        {{ item.grade }}
                                                    </span>
                                                    <span v-else-if="item.__cat === 'ujian'"
                                                        class="px-2 py-1 rounded text-xs font-black"
                                                        :class="(item.score >= 80) ? 'text-emerald-600 bg-emerald-50' : (item.score < 70) ? 'text-red-600 bg-red-50' : 'text-blue-600 bg-blue-50'">
                                                        {{ item.score }}
                                                    </span>
                                                    <span v-else-if="item.__cat === 'pelanggaran'"
                                                        class="px-2 py-1 rounded text-xs font-black text-red-600 bg-red-100">
                                                        -{{ item.points || item.poin || 0 }}
                                                    </span>
                                                </td>

                                                <!-- Aksi -->
                                                <!-- Aksi (Kebab Menu) -->
                                                <td class="px-4 py-3 text-center relative">
                                                    <button @click.stop="toggleActionMenu(item._id)"
                                                        class="p-1 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100 transition">
                                                        <span class="material-symbols-outlined">more_vert</span>
                                                    </button>

                                                    <!-- Dropdown -->
                                                    <div v-if="riwayatState.activeActionId === item._id"
                                                        class="absolute right-8 top-2 bg-white rounded-lg shadow-xl border border-slate-100 z-50 w-32 overflow-hidden text-left animate-fade-in flex flex-col">
                                                        <!-- Overlay for click-outside handled globally or by simple backdrop here if needed but global is better. 
                                                              For simplicity, we use a fixed backdrop conditionally rendered or just rely on global click handling if implemented. 
                                                              Given the constraints, let's just make a simple backdrop here for this item specifically or rely on the toggle logic. -->
                                                        <button @click="editRiwayat(item); closeActionMenu()"
                                                            class="px-4 py-2 hover:bg-slate-50 text-xs font-bold text-slate-600 flex items-center gap-2 w-full text-left">
                                                            <span class="material-symbols-outlined text-sm">edit</span>
                                                            Edit
                                                        </button>
                                                        <button @click="deleteRiwayat(item); closeActionMenu()"
                                                            class="px-4 py-2 hover:bg-red-50 text-xs font-bold text-red-600 flex items-center gap-2 w-full text-left border-t border-slate-50">
                                                            <span
                                                                class="material-symbols-outlined text-sm">delete</span>
                                                            Hapus
                                                        </button>
                                                    </div>

                                                    <!-- Backdrop to close -->
                                                    <div v-if="riwayatState.activeActionId === item._id"
                                                        @click="closeActionMenu()"
                                                        class="fixed inset-0 z-40 cursor-default"></div>
                                                </td>
                                            </tr>
                                            <tr v-if="paginatedRiwayat.length === 0">
                                                <td colspan="6"
                                                    class="px-4 py-8 text-center text-slate-400 font-bold text-xs">
                                                    Belum
                                                    ada
                                                    riwayat setoran/ujian.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- REKAP VIEW (New v34) -->
                        <div v-if="currentView === 'rekap'" class="fade-in space-y-6 pb-24">
                            <div class="px-2">
                                <h2 class="text-2xl font-bold text-slate-900">Rekap Laporan</h2>
                                <p class="text-xs text-slate-500">Analisa perkembangan santri</p>
                            </div>

                            <!-- Filter Control -->
                            <div class="bg-white p-4 rounded-2xl border shadow-sm mx-2 space-y-3">
                                <div class="flex gap-2">
                                    <select v-model="rekapMonth"
                                        class="bg-slate-50 border p-2 rounded-lg text-sm flex-1">
                                        <option v-for="(m, i) in monthNames" :value="i">{{ m }}</option>
                                    </select>
                                    <select v-model="rekapYear" class="bg-slate-50 border p-2 rounded-lg text-sm w-24">
                                        <option :value="2025">2025</option>
                                        <option :value="2026">2026</option>
                                    </select>
                                </div>
                                <div class="flex gap-2">
                                    <select v-model="rekapKelas"
                                        class="bg-slate-50 border p-2 rounded-lg text-sm flex-1">
                                        <option value="">Semua Kelas</option>
                                        <option v-for="k in uiData.kelas" :value="k.name">{{ k.name }}
                                        </option>
                                    </select>
                                    <select v-model="rekapGender"
                                        class="bg-slate-50 border p-2 rounded-lg text-sm w-32">
                                        <option value="">Semua</option>
                                        <option value="L">Putra</option>
                                        <option value="P">Putri</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Content: Laporan Prestasi -->
                            <div class="mx-2 space-y-4">
                                <div class="bg-white rounded-2xl border overflow-hidden">
                                    <div class="flex justify-between items-center p-4 border-b bg-slate-50">
                                        <h3 class="font-bold text-slate-700">Laporan Prestasi Santri</h3>
                                        <div class="flex gap-2">
                                            <button @click="exportToExcel()"
                                                class="p-2 bg-green-100 text-green-700 rounded-lg text-xs font-bold hover:bg-green-200">
                                                XLS
                                            </button>
                                            <button @click="exportToPDF"
                                                class="p-2 bg-red-100 text-red-700 rounded-lg text-xs font-bold hover:bg-red-200">
                                                PDF
                                            </button>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left text-xs">
                                            <thead class="bg-slate-50 text-slate-500 uppercase">
                                                <tr>
                                                    <th class="px-4 py-3">Nama</th>
                                                    <th class="px-4 py-3 text-center">Sabaq<br><span
                                                            class="text-[9px]">(Act/Tgt)</span></th>
                                                    <th class="px-4 py-3 text-center">Manzil<br><span
                                                            class="text-[9px]">(Act/Tgt)</span></th>
                                                    <th class="px-4 py-3 text-center">Ujian</th>
                                                    <th class="px-4 py-3 text-center">Pelanggaran</th>
                                                    <th class="px-4 py-3 text-center">Nilai</th>
                                                    <th class="px-4 py-3 text-center">Predikat</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y">
                                                <tr v-for="row in rekapHafalanData" :key="row.id">
                                                    <td class="px-4 py-3 font-medium text-slate-700">
                                                        {{ row.nama }}<br>
                                                        <span class="text-[10px] text-slate-400">{{ row.kelas }}</span>
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        <div class="font-bold text-blue-600">{{ row.sabaq_act }} / {{
                                                            row.sabaq_tgt }}</div>
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        <div class="font-bold text-purple-600">{{ row.manzil_act }} / {{
                                                            row.manzil_tgt }}</div>
                                                    </td>
                                                    <td class="px-4 py-3 text-center font-bold">
                                                        {{ row.ujian_avg }}
                                                    </td>
                                                    <td class="px-4 py-3 text-center text-red-500 font-bold">
                                                        {{ row.pelanggaran_poin > 0 ? '-' + row.pelanggaran_poin : '0'
                                                        }}
                                                    </td>
                                                    <td class="px-4 py-3 text-center font-bold text-slate-800">
                                                        {{ row.nilai_akhir }}
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span class="px-2 py-1 rounded-full font-bold text-[10px]"
                                                            :class="{
                                                                'bg-green-100 text-green-700': row.predikat === 'A+' || row.predikat === 'A',
                                                                'bg-blue-100 text-blue-700': row.predikat === 'B+' || row.predikat === 'B' || row.predikat === 'B-',
                                                                'bg-red-100 text-red-700': row.predikat === 'C'
                                                            }">
                                                            {{ row.predikat }}
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <!-- Empty State -->
                                        <div v-if="!rekapHafalanData.length"
                                            class="p-8 text-center text-slate-400 text-xs">
                                            Belum ada data untuk periode ini.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PROFILE VIEW -->
                        <div v-if="currentView === 'profile'" class="fade-in space-y-6 pb-24">
                            <div class="px-2">
                                <h2 class="text-2xl font-bold text-slate-900">Pengaturan Profil</h2>
                                <p class="text-xs text-slate-500">Perbarui informasi akun Anda</p>
                            </div>

                            <div class="bg-white p-6 rounded-3xl border shadow-sm mx-2">
                                <div class="flex flex-col items-center mb-6">
                                    <div class="relative mb-3">
                                        <!-- Photo or Initials -->
                                        <div v-if="userSession.photo_url"
                                            class="size-24 rounded-full shadow-lg overflow-hidden border-2 border-white">
                                            <img :src="userSession.photo_url" alt="Profile"
                                                class="w-full h-full object-cover">
                                        </div>
                                        <div v-else
                                            class="size-24 bg-primary rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-lg border-2 border-white">
                                            {{ getInitials(userSession.full_name) }}
                                        </div>

                                        <!-- Upload Button -->
                                        <label
                                            class="absolute bottom-0 right-0 bg-white text-slate-700 p-2 rounded-full shadow-md cursor-pointer hover:bg-slate-50 transition active:scale-95 flex items-center justify-center border border-slate-100">
                                            <input type="file" @change="handleFileSelect" accept="image/*"
                                                class="hidden">
                                            <span class="material-symbols-outlined text-lg">photo_camera</span>
                                        </label>

                                        <!-- Loading -->
                                        <div v-if="isUploading"
                                            class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-full z-10 backdrop-blur-[1px]">
                                            <div
                                                class="size-6 border-2 border-white border-t-transparent rounded-full animate-spin">
                                            </div>
                                        </div>
                                    </div>
                                    <h3 class="font-bold text-lg text-slate-900">{{ userSession.full_name }}</h3>
                                    <span
                                        class="px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-xs font-bold mt-1">
                                        {{ userSession.role === 'admin' ? 'Administrator' : (userSession.role ===
                                        'guru'
                                        ?
                                        'Guru / Staff' : 'Wali Santri') }}
                                    </span>
                                </div>

                                <div class="space-y-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Nama
                                            Lengkap</label>
                                        <input v-model="profileForm.full_name" type="text"
                                            class="w-full p-3 border rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-primary/20 focus:border-primary transition outline-none">
                                    </div>

                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Username
                                            (Login)</label>
                                        <input v-model="profileForm.username" type="text"
                                            :readonly="userSession.role === 'wali'"
                                            :class="userSession.role === 'wali' ? 'bg-slate-50 text-slate-500' : ''"
                                            class="w-full p-3 border rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-primary/20 focus:border-primary transition outline-none">
                                        <p v-if="userSession.role === 'wali'" class="text-[10px] text-slate-400 mt-1">
                                            *Username Wali mengikuti NIS Santri</p>
                                    </div>

                                    <div class="pt-2 border-t border-slate-100">
                                        <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Password
                                            Baru</label>
                                        <div class="relative">
                                            <input v-model="profileForm.password" type="password"
                                                placeholder="Kosongkan jika tidak ingin mengubah"
                                                class="w-full p-3 border rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-primary/20 focus:border-primary transition outline-none pr-10">
                                        </div>
                                    </div>

                                    <button @click="saveProfile"
                                        class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition mt-4">
                                        Simpan Perubahan
                                    </button>

                                    <button @click="logout"
                                        class="w-full border-2 border-red-100 text-red-500 py-3 rounded-xl font-bold hover:bg-red-50 active:scale-95 transition mt-4 flex items-center justify-center gap-2">
                                        <span class="material-symbols-outlined">logout</span> Keluar Aplikasi
                                    </button>
                                </div>
                            </div>

                            <div class="mx-2 p-4 rounded-xl bg-slate-50 border border-slate-100 text-center">
                                <p class="text-xs text-slate-400">App Version {{ appVersion }}</p>
                            </div>
                        </div>

                        <!-- MAPEL VIEW -->
                        <div v-if="currentView === 'mapel'" class="fade-in space-y-4 pb-24">
                            <div class="flex justify-between items-center">
                                <h2 class="text-2xl font-bold text-slate-900">Mata Pelajaran</h2>
                                <button @click="openMapelModal()"
                                    class="bg-primary text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-primary/30 active:scale-95 transition">
                                    + Tambah
                                </button>
                            </div>

                            <!-- Mapel List -->
                            <div class="space-y-3">
                                <div v-for="mapel in filteredMapel" :key="mapel._id"
                                    class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center hover:shadow-md transition">
                                    <h3 class="font-bold text-slate-900">{{ mapel.name }}</h3>
                                    <div class="flex gap-2">
                                        <button @click="openMapelModal(mapel)"
                                            class="size-9 flex items-center justify-center rounded-full text-primary hover:bg-primary/10 transition">
                                            <span class="material-symbols-outlined text-xl">edit</span>
                                        </button>
                                        <button @click="deleteMapel(mapel._id)"
                                            class="size-9 flex items-center justify-center rounded-full text-red-500 hover:bg-red-50 transition">
                                            <span class="material-symbols-outlined text-xl">delete</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Empty State -->
                                <div v-if="!filteredMapel || filteredMapel.length === 0"
                                    class="text-center py-12 text-slate-400">
                                    <span class="material-symbols-outlined text-6xl opacity-20">book_2</span>
                                    <p class="mt-2 text-sm">Belum ada mata pelajaran</p>
                                </div>
                            </div>
                        </div>

                        <!-- KELAS VIEW -->
                        <div v-if="currentView === 'kelas'" class="fade-in space-y-4 pb-24">
                            <div class="flex justify-between items-center px-2">
                                <h2 class="text-2xl font-bold text-slate-900">Data Kelas</h2>
                                <button @click="openKelasModal()"
                                    class="bg-primary text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-primary/30 active:scale-95 transition">
                                    + Tambah
                                </button>
                            </div>

                            <!-- Kelas List -->
                            <div class="space-y-3 px-2">
                                <div v-for="kelas in filteredKelas" :key="kelas._id"
                                    class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center hover:shadow-md transition">
                                    <h3 class="font-bold text-slate-900">{{ kelas.name }}</h3>
                                    <div class="flex gap-2">
                                        <button @click="openKelasModal(kelas)"
                                            class="size-9 flex items-center justify-center rounded-full text-primary hover:bg-primary/10 transition">
                                            <span class="material-symbols-outlined text-xl">edit</span>
                                        </button>
                                        <button @click="deleteKelas(kelas._id)"
                                            class="size-9 flex items-center justify-center rounded-full text-red-500 hover:bg-red-50 transition">
                                            <span class="material-symbols-outlined text-xl">delete</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Empty State -->
                                <div v-if="!filteredKelas || filteredKelas.length === 0"
                                    class="text-center py-12 text-slate-400">
                                    <span class="material-symbols-outlined text-6xl opacity-20">meeting_room</span>
                                    <p class="mt-2 text-sm">Belum ada data kelas</p>
                                </div>
                            </div>
                        </div>

                        <!-- QURAN VIEW -->
                        <div v-if="currentView === 'quran'"
                            class="flex flex-col bg-slate-50 h-[100dvh] pb-16 md:pb-0 md:h-[calc(100vh-4rem)]">
                            <!-- Header (Mobile only) Removed as per request, using global header -->

                            <!-- Quran Info Bar (Top) -->
                            <div
                                class="w-full bg-white border-b border-slate-200 px-4 py-2 flex justify-between items-center shadow-sm z-10 sticky top-0">
                                <span class="font-bold text-slate-500 text-xs w-1/3 text-left">Juz {{ currentJuz
                                    }}</span>
                                <span
                                    class="font-bold text-slate-900 text-sm w-1/3 text-center bg-slate-100 rounded-md py-1">{{
                                    quranState.page }}</span>
                                <span class="font-bold text-primary text-xs w-1/3 text-right truncate">{{
                                    currentSurahName
                                    }}</span>
                            </div>


                            <!-- Main Viewer Area -->
                            <div
                                class="flex-1 relative overflow-y-auto overflow-x-hidden bg-[#fdfaf7] flex flex-col items-center justify-start">
                                <div
                                    class="w-full min-h-full flex items-start justify-center relative p-0 md:p-0 md:h-full">
                                    <img :src="quranImageSrc"
                                        class="w-full h-auto shadow-lg transition-opacity duration-200 select-none border border-[#f0e6d2] md:max-h-full md:max-w-full md:object-contain md:h-full md:w-auto mt-0"
                                        alt="Halaman Quran">

                                    <!-- Click Areas for Nav (Invisible) -->
                                    <div class="absolute inset-0 flex">
                                        <div @click="nextQPage"
                                            class="w-1/2 h-full z-10 cursor-pointer active:bg-black/5 transition"
                                            title="Lanjut (Next)"></div>
                                        <div @click="prevQPage"
                                            class="w-1/2 h-full z-10 cursor-pointer active:bg-black/5 transition"
                                            title="Kembali (Prev)"></div>
                                    </div>

                                    <!-- Desktop Drawer Toggle Only -->
                                    <button @click="quranState.showDrawer = true"
                                        class="hidden md:flex absolute top-4 right-4 size-10 bg-white/50 hover:bg-white rounded-full items-center justify-center shadow z-20 text-slate-700 hover:text-primary transition"
                                        title="Menu Quran">
                                        <span class="material-symbols-outlined">menu</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Footer Info Removed -->


                            <!-- Draggable Exam Controls -->
                            <div v-if="showExamControls && currentView === 'quran' && ujianForm.santri_id"
                                class="fixed inset-0 z-40 bg-transparent" @click="showExamControls = false"></div>

                            <div v-if="currentView === 'quran' && ujianForm.santri_id && showExamControls"
                                class="fixed z-50 bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden w-40 touch-none transition-shadow hover:shadow-xl active:shadow-2xl"
                                :style="{ left: examControlPos.x + 'px', top: examControlPos.y + 'px' }"
                                @touchstart.passive="startDragExamControl" @touchmove.passive="dragExamControl"
                                @touchend="endDragExamControl" @mousedown="startDragExamControl"
                                @mousemove="dragExamControl" @mouseup="endDragExamControl"
                                @mouseleave="endDragExamControl">

                                <!-- Drag Handle -->
                                <div
                                    class="bg-primary px-3 py-2 cursor-move flex items-center justify-between text-white">
                                    <span class="text-[10px] font-bold uppercase tracking-wider">Kesalahan</span>
                                    <span class="material-symbols-outlined text-sm opacity-50">drag_indicator</span>
                                </div>

                                <!-- Content -->
                                <div class="p-3 bg-white space-y-3">
                                    <!-- Counter -->
                                    <div class="flex items-center justify-between gap-2">
                                        <button @click="updateSalah(-1)"
                                            class="size-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 active:scale-95 transition">
                                            <span class="material-symbols-outlined text-lg">remove</span>
                                        </button>
                                        <span class="text-2xl font-black text-red-500 min-w-[30px] text-center">{{
                                            ujianForm.tab === 'bulanan' ? ujianForm.b_salah : ujianForm.s_salah
                                            }}</span>
                                        <button @click="updateSalah(1)"
                                            class="size-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 active:scale-95 transition">
                                            <span class="material-symbols-outlined text-lg">add</span>
                                        </button>
                                    </div>

                                    <!-- Finish Button -->
                                    <button @click="finishExam"
                                        class="w-full py-2 bg-emerald-50 text-emerald-600 rounded-xl text-xs font-bold flex items-center justify-center gap-1 hover:bg-emerald-100 transition active:scale-95">
                                        <span class="material-symbols-outlined text-sm">check</span> Selesai
                                    </button>
                                </div>
                            </div>

                            <!-- Drawer (Jump) -->
                            <div v-if="quranState.showDrawer" class="absolute inset-0 bg-black/50 z-30"
                                @click.self="quranState.showDrawer=false">
                                <div
                                    class="absolute right-0 top-0 bottom-0 w-80 bg-white shadow-2xl flex flex-col animate-slide-in-right">
                                    <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                                        <h3 class="font-bold text-slate-800">Navigasi Quran</h3>
                                        <button @click="quranState.showDrawer=false"
                                            class="size-8 flex items-center justify-center hover:bg-slate-200 rounded-full"><span
                                                class="material-symbols-outlined">close</span></button>
                                    </div>
                                    <div class="p-4 space-y-6 overflow-y-auto flex-1 h-full pb-20">
                                        <!-- 1. Jump Page -->
                                        <div class="space-y-2">
                                            <label
                                                class="text-xs font-bold text-slate-500 uppercase tracking-wider">Loncat
                                                ke Halaman</label>
                                            <div class="flex gap-2">
                                                <input v-model="quranState.jumpPage" type="number"
                                                    class="w-full border rounded-lg px-3 py-2 text-sm font-bold bg-white focus:outline-none focus:border-primary"
                                                    min="1" max="604" placeholder="1 - 604">
                                                <button @click="jumpToPage"
                                                    class="bg-primary text-white px-4 py-2 rounded-lg font-bold text-sm">Go</button>
                                            </div>
                                        </div>

                                        <!-- 2. Cari Surat & Ayat -->
                                        <div class="space-y-3 pt-4 border-t border-dashed">
                                            <label
                                                class="text-xs font-bold text-slate-500 uppercase tracking-wider">Cari
                                                Surat & Ayat</label>
                                            <select v-model="quranState.jumpSurah"
                                                class="w-full border rounded-lg px-3 py-2 text-sm font-bold bg-white mb-2">
                                                <option value="">Pilih Surat...</option>
                                                <option v-for="s in uiData.surahList" :value="s.no">{{ s.no }}. {{
                                                    s.latin
                                                    }}</option>
                                            </select>
                                            <div class="flex gap-2">
                                                <input v-model="quranState.jumpAyat" type="number"
                                                    class="w-full border rounded-lg px-3 py-2 text-sm font-bold bg-white focus:outline-none focus:border-primary"
                                                    placeholder="Ayat No.">
                                                <button @click="jumpToAyat"
                                                    class="bg-primary text-white px-4 py-2 rounded-lg font-bold text-sm">Cari</button>
                                            </div>
                                        </div>

                                        <!-- 3. Indeks Juz -->
                                        <div class="space-y-2 pt-4 border-t border-dashed">
                                            <label
                                                class="text-xs font-bold text-slate-500 uppercase tracking-wider">Indeks
                                                Juz</label>
                                            <select @change="goToJuz($event.target.value)"
                                                class="w-full border rounded-lg px-3 py-2 text-sm font-bold bg-white mb-2">
                                                <option value="">Pilih Juz...</option>
                                                <option v-for="j in 30" :key="j" :value="j">Juz {{ j }}</option>
                                            </select>
                                        </div>

                                        <!-- 4. Indeks Surat -->
                                        <div class="space-y-2 pt-4 border-t border-dashed">
                                            <label
                                                class="text-xs font-bold text-slate-500 uppercase tracking-wider">Indeks
                                                Surat</label>
                                            <div class="space-y-1">
                                                <button v-for="s in uiData.surahList" :key="s.no"
                                                    @click="goToSurah(s.no)"
                                                    class="w-full text-left p-2 rounded hover:bg-slate-50 flex items-center gap-3 border-b border-transparent hover:border-slate-100 transition group">
                                                    <span
                                                        class="font-bold text-xs text-slate-400 group-hover:text-primary w-6">{{
                                                        s.no }}</span>
                                                    <div class="flex-1">
                                                        <p class="font-bold text-sm text-slate-800">{{ s.latin }}
                                                        </p>
                                                        <p class="text-[10px] text-slate-400 italic">{{ s.arti }} •
                                                            {{
                                                            s.ayat }} Ayat</p>
                                                    </div>
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-else-if="currentView === 'hafalan'" class="fade-in pb-24">

                            <!-- List Santri (Monitoring) -->
                            <div v-if="!ujianForm.santri_id" class="px-4 pt-4 space-y-4">
                                <div>
                                    <h2 class="text-2xl font-bold text-slate-900">Monitoring Hafalan</h2>
                                    <p class="text-xs text-slate-500">Pantau progres 30 Juz santri.</p>
                                </div>

                                <div class="bg-white p-3 rounded-xl border shadow-sm sticky top-0 z-20">
                                    <input v-model="searchText" type="text" placeholder="Cari Nama Santri..."
                                        class="w-full p-2 bg-slate-50 border rounded-lg text-sm font-bold focus:outline-none focus:border-primary">
                                </div>

                                <!-- Gender Filter -->
                                <div class="flex p-1 bg-slate-100 rounded-xl mb-4">
                                    <button @click="santriGenderFilter = 'L'"
                                        :class="santriGenderFilter === 'L' ? 'bg-white text-blue-600 shadow-sm font-bold' : 'text-slate-500 hover:text-slate-700'"
                                        class="flex-1 py-2 text-xs rounded-lg transition-all">
                                        Putra
                                    </button>
                                    <button @click="santriGenderFilter = 'P'"
                                        :class="santriGenderFilter === 'P' ? 'bg-white text-pink-500 shadow-sm font-bold' : 'text-slate-500 hover:text-slate-700'"
                                        class="flex-1 py-2 text-xs rounded-lg transition-all">
                                        Putri
                                    </button>
                                </div>

                                <div class="space-y-3">
                                    <div v-for="s in filteredSantri" :key="s._id"
                                        @click="ujianForm.santri_id = s.santri_id; ujianForm.tab='semester'; selectUjianJuz(null)"
                                        class="bg-white p-4 rounded-2xl border shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50 transition group">
                                        <div class="flex items-center gap-4">
                                            <div
                                                class="size-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center font-bold text-lg shadow-lg shadow-indigo-200">
                                                {{ (s.hafalan_manual || '0 Juz').split(' ')[0] }}
                                            </div>
                                            <div>
                                                <h4
                                                    class="font-bold text-slate-900 group-hover:text-primary transition">
                                                    {{
                                                    s.full_name }}</h4>
                                                <p class="text-xs text-slate-500 font-mono">{{ s.kelas || 'No Kelas'
                                                    }}
                                                    • {{
                                                    s.hafalan_manual || '0 Juz' }}</p>
                                            </div>
                                        </div>
                                        <span class="material-symbols-outlined text-slate-300">chevron_right</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Detail Grid (30 Juz) -->
                            <div v-else class="px-4 pt-4 space-y-4">
                                <div class="flex items-center gap-3">
                                    <button @click="ujianForm.santri_id = ''"
                                        class="size-10 rounded-full bg-white border shadow-sm flex items-center justify-center hover:bg-slate-50">
                                        <span class="material-symbols-outlined">arrow_back</span>
                                    </button>
                                    <div>
                                        <h2 class="text-xl font-bold text-slate-900">{{
                                            getSantriName(ujianForm.santri_id)
                                            }}</h2>
                                        <p class="text-xs text-slate-500">Progres 30 Juz</p>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded-3xl border shadow-sm mx-2">
                                    <div class="grid grid-cols-5 gap-3 sm:gap-4 justify-items-center">
                                        <button v-for="j in 30" :key="j"
                                            @click="selectUjianJuz(j); modalState.view='grading'; modalState.isOpen=true;"
                                            class="size-12 sm:size-14 rounded-full border-2 flex flex-col items-center justify-center transition-all transform hover:scale-110 active:scale-95 bg-slate-50 text-slate-400 border-slate-200 hover:border-emerald-300"
                                            :class="{
                                            'bg-blue-500 text-white shadow-lg shadow-blue-200 border-transparent': selectedSantriProgress[j] && ['A+', 'A'].includes(selectedSantriProgress[j]),
                                            'bg-emerald-500 text-white shadow-lg shadow-emerald-200 border-transparent': selectedSantriProgress[j] && ['B+', 'B', 'B-', 'B'].includes(selectedSantriProgress[j]),
                                            'bg-red-500 text-white shadow-lg shadow-red-200 border-transparent': selectedSantriProgress[j] === 'C',
                                            'bg-orange-400 text-white shadow-lg shadow-orange-200 border-transparent': selectedSantriProgress[j] === 'Centang'
                                        }">
                                            <span class="text-sm sm:text-lg font-bold">{{ j }}</span>
                                            <span v-if="selectedSantriProgress[j]"
                                                class="text-[9px] font-black uppercase tracking-tighter opacity-90">
                                                {{ selectedSantriProgress[j] === 'Centang' ? 'OK' :
                                                selectedSantriProgress[j] }}
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                </main>

                <!-- BOTTOM NAV (Mobile) -->
                <nav v-if="bottomMenus.length > 0"
                    class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-[50] h-16 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] pb-safe">
                    <div class="flex h-full w-full relative">
                        <template v-for="menu in bottomMenus" :key="menu.id">
                            <!-- Highlighted Item (Center) -->
                            <div v-if="menu.highlight" class="w-1/5 flex justify-center items-center relative">
                                <div class="floating-btn-wrapper">
                                    <button @click="navigateTo(menu.id)" class="floating-btn">
                                        <span class="material-symbols-outlined text-[32px]">{{ menu.icon }}</span>
                                    </button>
                                </div>
                            </div>
                            <!-- Standard Item -->
                            <button v-else @click="navigateTo(menu.id)"
                                class="w-1/5 flex flex-col items-center justify-center active:scale-95 transition-transform"
                                :class="currentView === menu.id ? 'active' : 'text-slate-400'">
                                <span class="material-symbols-outlined text-[30px]">{{ menu.icon }}</span>
                            </button>
                        </template>
                        <!-- Logout Button -->

                    </div>
                </nav>

            </div>
        </div>

        <!-- MAPEL MODAL FORM -->
        <div v-if="mapelModalState.isOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
            @click.self="closeMapelModal">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 space-y-4">
                <h3 class="font-bold text-lg text-slate-900">{{ mapelModalState.title }}</h3>

                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-1">Nama Mata Pelajaran</label>
                    <input v-model="mapelForm.name" type="text" placeholder="Matematika, Bahasa Arab, dll"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                        required>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" @click="closeMapelModal"
                        class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">
                        Batal
                    </button>
                    <button @click="saveMapel"
                        class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">
                        Simpan
                    </button>
                </div>
            </div>
        </div>

        <!-- KELAS MODAL FORM -->
        <div v-if="kelasModalState.isOpen" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
            @click.self="closeKelasModal">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 space-y-4">
                <h3 class="font-bold text-lg text-slate-900">{{ kelasModalState.title }}</h3>

                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-1">Nama Kelas</label>
                    <input v-model="kelasForm.name" type="text" placeholder="Kelas A, Kelas B, Ruang 1, dll"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                        required>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" @click="closeKelasModal"
                        class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">
                        Batal
                    </button>
                    <button @click="saveKelas"
                        class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">
                        Simpan
                    </button>
                </div>
            </div>
        </div>

        <!-- JADWAL MODAL FORM -->


        <!-- ABSENSI MODAL FORM -->
        <div v-if="absensiState.activeJadwal"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
            @click.self="absensiState.activeJadwal = null">
            <div class="bg-white rounded-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh]">
                <!-- Header -->
                <div class="p-4 border-b flex justify-between items-center">
                    <div class="flex-1 mr-4">
                        <h3 class="font-bold text-lg text-slate-900 truncate">
                            {{ absensiState.activeJadwal.mapel || 'Absensi' }}
                        </h3>
                        <p class="text-xs text-slate-500 font-bold">
                            {{ absensiState.dateFilter }} • {{ absensiState.activeJadwal.time || '' }} •
                            {{ absensiState.activeJadwal.class_name || 'Semua Kelas' }}
                        </p>
                    </div>
                    <button @click="absensiState.activeJadwal = null"
                        class="size-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 font-bold">
                        ✕
                    </button>
                </div>

                <!-- Bulk Actions -->
                <div class="bg-blue-50 p-3 border-b border-blue-100 flex justify-between items-center">
                    <span class="text-xs font-bold text-blue-700">Set Semua Ke:</span>
                    <div class="flex gap-1">
                        <button @click="setAllAbsensi('H')"
                            class="px-3 py-1.5 rounded bg-green-100 text-green-700 text-xs font-bold hover:bg-green-200 transition">
                            Hadir
                        </button>
                        <button @click="setAllAbsensi('S')"
                            class="px-3 py-1.5 rounded bg-yellow-100 text-yellow-700 text-xs font-bold hover:bg-yellow-200 transition">
                            Sakit
                        </button>
                        <button @click="setAllAbsensi('I')"
                            class="px-3 py-1.5 rounded bg-blue-100 text-blue-700 text-xs font-bold hover:bg-blue-200 transition">
                            Izin
                        </button>
                        <button @click="setAllAbsensi('A')"
                            class="px-3 py-1.5 rounded bg-red-100 text-red-700 text-xs font-bold hover:bg-red-200 transition">
                            Alpha
                        </button>
                    </div>
                </div>

                <!-- Santri List (Scrollable) -->
                <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                    <div v-for="santri in absensiState.santriList" :key="santri._id"
                        class="bg-white p-3 rounded-xl border shadow-sm">
                        <!-- Santri Info -->
                        <div class="flex justify-between items-center border-b pb-2 mb-2">
                            <span class="font-bold text-slate-800 text-sm truncate flex-1 mr-2">
                                {{ santri.full_name }}
                            </span>
                            <span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded">
                                {{ santri.kelas || '-' }}
                            </span>
                        </div>

                        <!-- Status Radio Buttons -->
                        <div class="grid grid-cols-4 gap-2">
                            <!-- Hadir -->
                            <label class="cursor-pointer">
                                <input type="radio" :name="'abs_' + santri._id" value="H"
                                    :checked="formState[santri._id] === 'H'"
                                    @change="updateSantriStatus(santri._id, 'H')" class="peer sr-only">
                                <div class="text-center py-2 rounded-lg border text-xs font-bold transition-all
                                    peer-checked:bg-green-500 peer-checked:ring-2 peer-checked:ring-green-300 
                                    peer-checked:border-transparent peer-checked:text-white
                                    text-green-600 bg-green-50 hover:bg-green-100">
                                    Hadir
                                </div>
                            </label>

                            <!-- Sakit -->
                            <label class="cursor-pointer">
                                <input type="radio" :name="'abs_' + santri._id" value="S"
                                    :checked="formState[santri._id] === 'S'"
                                    @change="updateSantriStatus(santri._id, 'S')" class="peer sr-only">
                                <div class="text-center py-2 rounded-lg border text-xs font-bold transition-all
                                    peer-checked:bg-yellow-500 peer-checked:ring-2 peer-checked:ring-yellow-300 
                                    peer-checked:border-transparent peer-checked:text-white
                                    text-yellow-600 bg-yellow-50 hover:bg-yellow-100">
                                    Sakit
                                </div>
                            </label>

                            <!-- Izin -->
                            <label class="cursor-pointer">
                                <input type="radio" :name="'abs_' + santri._id" value="I"
                                    :checked="formState[santri._id] === 'I'"
                                    @change="updateSantriStatus(santri._id, 'I')" class="peer sr-only">
                                <div class="text-center py-2 rounded-lg border text-xs font-bold transition-all
                                    peer-checked:bg-blue-500 peer-checked:ring-2 peer-checked:ring-blue-300 
                                    peer-checked:border-transparent peer-checked:text-white
                                    text-blue-600 bg-blue-50 hover:bg-blue-100">
                                    Izin
                                </div>
                            </label>

                            <!-- Alpha -->
                            <label class="cursor-pointer">
                                <input type="radio" :name="'abs_' + santri._id" value="A"
                                    :checked="formState[santri._id] === 'A'"
                                    @change="updateSantriStatus(santri._id, 'A')" class="peer sr-only">
                                <div class="text-center py-2 rounded-lg border text-xs font-bold transition-all
                                    peer-checked:bg-red-500 peer-checked:ring-2 peer-checked:ring-red-300 
                                    peer-checked:border-transparent peer-checked:text-white
                                    text-red-600 bg-red-50 hover:bg-red-100">
                                    Alpha
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div v-if="!absensiState.santriList || absensiState.santriList.length === 0"
                        class="text-center py-12 text-slate-400">
                        <span class="material-symbols-outlined text-4xl opacity-20">group_off</span>
                        <p class="mt-2 text-sm font-bold">Tidak ada santri di kelas ini</p>
                    </div>
                </div>

                <!-- Footer / Save Button -->
                <div class="p-4 border-t bg-white">
                    <button @click="saveAbsensi()"
                        class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-800 transition text-sm uppercase tracking-wide">
                        Simpan Absensi
                    </button>
                </div>
            </div>
        </div>

        <!-- TARGET MODAL -->
        <div v-if="targetModalState.isOpen" @click.self="closeTargetModal()"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div @click.stop
                class="bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[85vh] overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-indigo-50 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-slate-900">Atur Target Bulanan</h3>
                    <button @click="closeTargetModal()"
                        class="size-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-red-500 transition"><span
                            class="material-symbols-outlined">close</span></button>
                </div>

                <!-- Modal Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- Santri Info -->
                    <div class="flex items-center gap-3 mb-5 bg-blue-50 p-3 rounded-xl border border-blue-100">
                        <div
                            class="size-10 bg-white rounded-full flex items-center justify-center font-bold text-blue-600 shadow-sm">
                            {{ targetForm.full_name.charAt(0) }}
                        </div>
                        <div>
                            <p class="font-bold text-slate-900 text-sm">{{ targetForm.full_name }}</p>
                            <p class="text-[10px] text-slate-500 uppercase font-bold">Total Hafalan: {{
                                targetForm.hafalan_desc }}</p>
                        </div>
                    </div>

                    <!-- Sabaq Input -->
                    <div class="mb-5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Target Sabaq (Hafalan
                            Baru)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" v-model.number="targetForm.sabaq"
                                class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center text-lg">
                            <div class="text-xs font-bold text-slate-400 whitespace-nowrap">Hal/Bulan</div>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">*Hafalan baru yang harus disetor setiap bulan</p>
                    </div>

                    <!-- Manzil Input -->
                    <div class="mb-5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Target Manzil
                            (Murojaah)</label>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-1">
                                <label
                                    class="text-[9px] font-bold text-slate-400 uppercase text-center block mb-1">Persen
                                    %</label>
                                <input type="number" v-model.number="targetForm.pct"
                                    @input="recalcManzil(targetForm.pct)"
                                    class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center">
                            </div>
                            <div class="col-span-2">
                                <label
                                    class="text-[9px] font-bold text-slate-400 uppercase text-center block mb-1">Target
                                    Halaman</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" v-model.number="targetForm.manzil"
                                        class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center text-lg">
                                    <div class="text-xs font-bold text-slate-400">Hal</div>
                                </div>
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">*Total Hafalan: {{ targetForm.totalPages }} Halaman
                        </p>
                    </div>

                    <!-- Save Button -->
                    <button @click="saveTarget()"
                        class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-primary/30 hover:bg-blue-800 transition">
                        Simpan Target
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL OVERLAY -->
        <div v-if="modalState.isOpen"
            class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
            <div
                class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden max-h-[90vh] flex flex-col transform transition-all scale-100">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="font-bold text-lg text-slate-800">{{ modalState.title }}</h3>
                    <button @click="closeModal"
                        class="size-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-red-500 transition"><span
                            class="material-symbols-outlined">close</span></button>
                </div>

                <!-- Modal Content -->
                <div class="p-6 overflow-y-auto">

                    <!-- FORM SANTRI -->
                    <form v-if="modalState.view === 'santri-form'" @submit.prevent="saveSantri" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">NIS (Otomatis)</label>
                                <input v-model="santriForm.nis" type="text"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-700 font-bold focus:outline-none focus:border-primary"
                                    readonly>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Kelas</label>
                                <select v-model="santriForm.class_id"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                    <option value="">Pilih Kelas</option>
                                    <option v-for="k in uiData.kelas" :value="k.name">{{ k.name }}</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Nama Lengkap</label>
                            <input v-model="santriForm.full_name" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary bg-white"
                                placeholder="Nama lengkap santri" required>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Username (Opsional)</label>
                            <input v-model="santriForm.username" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary bg-white"
                                placeholder="Username untuk login alternatif">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Jenis Kelamin</label>
                                <select v-model="santriForm.gender"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                    <option value="L">Laki-laki</option>
                                    <option value="P">Perempuan</option>
                                </select>
                            </div>
                        </div>

                        <!-- Informasi Wali -->
                        <div class="pt-4 border-t border-slate-100">
                            <h4 class="text-xs font-bold text-slate-800 mb-3">Informasi Wali</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <input v-model="santriForm.parent_name" type="text"
                                    class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-primary bg-white text-sm"
                                    placeholder="Nama Wali">
                                <input v-model="santriForm.parent_phone" type="text"
                                    class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-primary bg-white text-sm"
                                    placeholder="No. HP / WA">
                            </div>
                            <div class="mt-3">
                                <label class="block text-xs font-bold text-slate-700 mb-1">Password Wali (Login)</label>
                                <input v-model="santriForm.password" type="password"
                                    class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-primary bg-white text-sm"
                                    placeholder="Isi untuk ubah password">
                            </div>
                        </div>

                        <!-- Target Hafalan Removed -->

                        <div class="pt-4 flex gap-3">
                            <button type="button" @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button type="submit"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan</button>
                        </div>
                    </form>

                    <!-- FORM GURU -->
                    <form v-if="modalState.view === 'guru'" @submit.prevent="saveGuru" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Nama Lengkap</label>
                            <input v-model="guruForm.full_name" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                                required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Nomor Induk Guru (NIG)</label>
                            <input v-model="guruForm.username" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                                placeholder="Generated ID" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Username (Opsional)</label>
                            <input v-model="guruForm.custom_username" type="text"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                                placeholder="Username alternatif">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Password</label>
                            <input v-model="guruForm.password" type="password"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white"
                                placeholder="Biarkan kosong jika tidak diubah">
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button type="button" @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button type="submit"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan</button>
                        </div>
                    </form>

                    <!-- FORM JADWAL -->
                    <form v-if="modalState.view === 'jadwal'" @submit.prevent="saveJadwal" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Hari</label>
                            <select v-model="jadwalForm.day"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                <option v-for="d in ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Ahad']"
                                    :value="d">{{ d }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Peruntukan</label>
                            <select v-model="jadwalForm.gender"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                <option value="L">Putra</option>
                                <option value="P">Putri</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Mata Pelajaran</label>
                            <select v-model="jadwalForm.mapel"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                <option value="">Pilih Mapel</option>
                                <option v-for="m in uiData.mapel" :value="m.name">{{ m.name }}</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Mulai</label>
                                <input v-model="jadwalForm.time_start" type="time"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Selesai</label>
                                <input v-model="jadwalForm.time_end" type="time"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Kelas</label>
                                <select v-model="jadwalForm.class_name"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                    <option value="">Pilih Kelas</option>
                                    <option v-for="k in uiData.kelas" :value="k.name">{{ k.name }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Guru</label>
                                <select v-model="jadwalForm.teacher"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:border-primary bg-white">
                                    <option value="">Pilih Guru</option>
                                    <option v-for="g in uiData.guru" :value="g.full_name">{{ g.full_name }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="pt-4 flex gap-3">
                            <button type="button" @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button type="submit"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan</button>
                        </div>
                    </form>

                    <!-- FORM ABSENSI -->
                    <div v-if="modalState.view === 'absensi'" class="space-y-4">
                        <!-- Info Jadwal -->
                        <div v-if="absensiState.activeJadwal"
                            class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-slate-900">{{ absensiState.activeJadwal.mapel }}</h4>
                                    <p class="text-xs text-slate-500 font-mono">{{ absensiState.activeJadwal.class_name
                                        }} • {{ absensiState.activeJadwal.time }}</p>
                                    <p class="text-xs text-slate-500 mt-1">{{ absensiState.activeJadwal.teacher }}</p>
                                </div>
                                <div
                                    class="bg-white px-2 py-1 rounded-lg border text-xs font-bold text-slate-500 shadow-sm">
                                    {{ absensiState.santriList.length }} Santri
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions -->
                        <div class="flex gap-2 overflow-x-auto pb-2">
                            <button type="button" @click="setAllAbsensi('H')"
                                class="px-3 py-1.5 rounded-lg bg-green-50 text-green-700 text-xs font-bold border border-green-200 hover:bg-green-100">Semua
                                Hadir</button>
                            <button type="button" @click="setAllAbsensi('S')"
                                class="px-3 py-1.5 rounded-lg bg-yellow-50 text-yellow-700 text-xs font-bold border border-yellow-200 hover:bg-yellow-100">Semua
                                Sakit</button>
                            <button type="button" @click="setAllAbsensi('I')"
                                class="px-3 py-1.5 rounded-lg bg-blue-50 text-blue-700 text-xs font-bold border border-blue-200 hover:bg-blue-100">Semua
                                Izin</button>
                        </div>

                        <!-- Santri List -->
                        <div class="space-y-2 max-h-[400px] overflow-y-auto pr-1">
                            <div v-for="s in absensiState.santriList" :key="s._id"
                                class="flex items-center justify-between p-3 rounded-xl border border-slate-100 hover:border-slate-200 transition bg-slate-50/50">
                                <div>
                                    <p class="font-bold text-slate-800 text-sm">{{ s.full_name }}</p>
                                    <p class="text-[10px] text-slate-400">{{ s.nis || '-' }}</p>
                                </div>
                                <div class="flex gap-1 bg-white p-1 rounded-lg border shadow-sm">
                                    <button type="button" @click="updateSantriStatus(s._id, 'H')"
                                        class="size-8 rounded-md flex items-center justify-center font-bold text-xs transition-all"
                                        :class="formState[s._id] === 'H' ? 'bg-green-500 text-white shadow' : 'text-slate-400 hover:bg-slate-50'">H</button>
                                    <button type="button" @click="updateSantriStatus(s._id, 'S')"
                                        class="size-8 rounded-md flex items-center justify-center font-bold text-xs transition-all"
                                        :class="formState[s._id] === 'S' ? 'bg-yellow-500 text-white shadow' : 'text-slate-400 hover:bg-slate-50'">S</button>
                                    <button type="button" @click="updateSantriStatus(s._id, 'I')"
                                        class="size-8 rounded-md flex items-center justify-center font-bold text-xs transition-all"
                                        :class="formState[s._id] === 'I' ? 'bg-blue-500 text-white shadow' : 'text-slate-400 hover:bg-slate-50'">I</button>
                                    <button type="button" @click="updateSantriStatus(s._id, 'A')"
                                        class="size-8 rounded-md flex items-center justify-center font-bold text-xs transition-all"
                                        :class="formState[s._id] === 'A' ? 'bg-red-500 text-white shadow' : 'text-slate-400 hover:bg-slate-50'">A</button>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="pt-4 flex gap-3 border-t border-slate-50">
                            <button type="button" @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button type="button" @click="saveAbsensi().then(ok => { if(ok) closeModal(); })"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan
                                Absensi</button>
                        </div>
                    </div>

                    <!-- FORM TARGET -->
                    <div v-if="modalState.view === 'target-form'" class="space-y-4">
                        <div class="flex items-center gap-3 mb-2 bg-blue-50 p-3 rounded-xl border border-blue-100">
                            <div
                                class="size-10 bg-white rounded-full flex items-center justify-center font-bold text-blue-600 shadow-sm">
                                {{ getInitials(targetForm.full_name) }}</div>
                            <div>
                                <p class="font-bold text-slate-900 text-sm">{{ targetForm.full_name }}</p>
                                <p class="text-[10px] text-slate-500 uppercase font-bold">Total Hafalan: {{
                                    targetForm.hafalan_desc }}</p>
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Target Sabaq
                                (Hafalan Baru)</label>
                            <div class="flex items-center gap-2">
                                <input v-model.number="targetForm.sabaq" type="number"
                                    class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center text-lg">
                                <div class="text-xs font-bold text-slate-400">Hal/Bulan</div>
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Target Manzil
                                (Murojaah)</label>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="col-span-1">
                                    <label
                                        class="text-[9px] font-bold text-slate-400 uppercase text-center block mb-1">Persen
                                        %</label>
                                    <input v-model.number="targetForm.pct" @input="recalcManzil" type="number"
                                        class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center">
                                </div>
                                <div class="col-span-2">
                                    <label
                                        class="text-[9px] font-bold text-slate-400 uppercase text-center block mb-1">Target
                                        Halaman</label>
                                    <div class="flex items-center gap-2">
                                        <input v-model.number="targetForm.manzil" type="number"
                                            class="w-full p-3 border rounded-xl font-bold text-slate-700 text-center text-lg">
                                        <div class="text-xs font-bold text-slate-400">Hal</div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-1">*Total Hafalan: {{ targetForm.totalPages }}
                                Halaman</p>
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button @click="closeModal"
                                class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            <button @click="saveTarget"
                                class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan
                                Target</button>
                        </div>
                    </div>

                    <!-- GRADING MODAL -->
                    <div v-if="modalState.view === 'grading'" class="space-y-6">
                        <!-- Manual Score Input -->
                        <div
                            class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100 flex items-center justify-between">
                            <div class="flex flex-col">
                                <label class="font-bold text-slate-700 text-sm">Nilai Manual</label>
                                <span class="text-[10px] text-slate-500 uppercase font-black">Skala 0-100</span>
                            </div>
                            <input v-model.number="ujianForm.s_score_manual" type="number" min="0" max="100"
                                class="w-24 px-3 py-3 text-center font-bold text-xl rounded-xl border border-slate-200 focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>

                        <!-- Grade Buttons Grid -->
                        <div class="space-y-3">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Pilih
                                Predikat</label>
                            <div class="grid grid-cols-3 gap-2">
                                <!-- Helper to set grade -->
                                <button v-for="g in ['A+', 'A', 'B+', 'B', 'B-', 'C']" :key="g" @click="setGrade(g)"
                                    class="py-3 rounded-xl border-2 font-bold transition flex items-center justify-center text-sm"
                                    :class="ujianForm.s_grade === g ? 'bg-primary text-white border-primary shadow-lg' : 'bg-white text-slate-600 border-slate-100 hover:border-blue-200'">
                                    {{ g }}
                                </button>
                            </div>

                            <!-- Centang Special Case -->
                            <button @click="setGrade('Centang')"
                                class="w-full mt-2 p-3 rounded-xl border-2 font-bold transition flex items-center justify-center gap-2"
                                :class="ujianForm.s_grade === 'Centang' ? 'bg-orange-500 text-white border-orange-500 shadow-lg' : 'bg-white text-orange-500 border-orange-100 hover:border-orange-200 text-sm'">
                                <span class="material-symbols-outlined text-xl">check_circle</span> Selesai
                            </button>
                        </div>

                        <!-- Reset / Delete -->
                        <div class="pt-4 border-t">
                            <button @click="setGrade(null); submitUjian()"
                                class="w-full p-3 rounded-xl border border-red-100 text-red-500 font-bold hover:bg-red-50 flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined">delete</span> Hapus
                            </button>
                        </div>

                        <!-- Save & Nav Buttons -->
                        <div class="flex flex-col gap-2 pt-2">
                            <button @click="submitUjian(); closeModal()"
                                class="w-full py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition flex items-center justify-center gap-2">
                                Simpan
                            </button>

                            <button @click="selectUjianJuz(ujianForm.s_juz, true)"
                                class="w-full py-3 rounded-xl bg-slate-800 text-white font-bold hover:bg-slate-900 transition flex items-center justify-center gap-2">
                                Lihat Al-Qur'an
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>



        <!--  Guru Modal Form -->


        <!-- CROP MODAL -->
        <div v-if="cropModal.isOpen"
            class="fixed inset-0 z-[70] bg-black/90 flex items-center justify-center p-4 fade-in">
            <div class="bg-white rounded-2xl overflow-hidden shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
                <div class="p-4 bg-white flex justify-between items-center border-b z-10">
                    <h3 class="font-bold text-lg text-slate-800">Sesuaikan Foto</h3>
                    <button @click="cancelCrop"
                        class="size-8 rounded-full hover:bg-slate-100 text-slate-400 font-bold flex items-center justify-center">✕</button>
                </div>
                <div class="flex-1 overflow-hidden bg-black flex items-center justify-center relative">
                    <img ref="cropperImage" :src="cropModal.imageSrc"
                        class="max-w-full max-h-[60vh] block object-contain">
                </div>
                <div class="p-4 bg-white border-t z-10 flex gap-3">
                    <button @click="cancelCrop"
                        class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                    <button @click="saveCrop"
                        class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-800 shadow-lg shadow-blue-900/20 transition">Simpan
                        Foto</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Core Logic -->
    <script src="js/core.js"></script>
    <script src="js/utils_date.js"></script>
    <script src="js/utils_password.js"></script>
    <script src="js/composables/useAuth.js"></script>
    <!-- Composables (load before main app) -->
    <script src="js/composables/usePelanggaran.js"></script>
    <script src="js/composables/useSantri.js"></script> <!-- PDF & Excel Libs (v34) -->


    <!-- Composables -->
    <script src="js/composables/useRekap.js"></script>
    <script src="js/composables/useGuru.js"></script>
    <script src="js/composables/useMapel.js"></script>
    <script src="js/composables/useKelas.js"></script>
    <script src="js/composables/useJadwal.js"></script>
    <script src="js/composables/useAbsensi.js"></script>
    <script src="js/composables/useTarget.js"></script>
    <script src="js/composables/useUjian.js"></script>
    <script src="js/composables/useRiwayat.js"></script>
    <script src="js/composables/useSetoran.js"></script>
    <script src="js/composables/useQuran.js"></script>
    <script src="js/composables/useDashboard.js"></script>
    <script src="js/composables/useProfile.js"></script>

    <!-- Main App -->
    <script src="js/app_vue.js"></script>
</body>

</html>